{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/trader/app/api/analyze/route.ts"],"sourcesContent":["import \"server-only\";\r\nimport { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport WebSocket from \"ws\";\nimport OpenAI from \"openai\";\nimport { randomUUID } from \"crypto\";\n\r\nexport const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\nexport const revalidate = 0;\r\n\r\n/* ===================== TYPES ===================== */\r\n\r\ntype Timeframe = \"5m\" | \"15m\" | \"1h\" | \"4h\" | \"12h\" | \"1d\" | \"3d\";\n\nconst TF_ORDER: Timeframe[] = [\"5m\", \"15m\", \"1h\", \"4h\", \"12h\", \"1d\", \"3d\"];\nconst TF_ORDER_INDEX = new Map<Timeframe, number>(TF_ORDER.map((tf, i) => [tf, i]));\nconst TF_MS: Record<Timeframe, number> = {\n  \"5m\": 5 * 60 * 1000,\n  \"15m\": 15 * 60 * 1000,\n  \"1h\": 60 * 60 * 1000,\n  \"4h\": 4 * 60 * 60 * 1000,\n  \"12h\": 12 * 60 * 60 * 1000,\n  \"1d\": 24 * 60 * 60 * 1000,\n  \"3d\": 3 * 24 * 60 * 60 * 1000,\n};\n\r\ntype SetupType = \"NONE\" | \"TREND_CONTINUATION\" | \"PULLBACK\" | \"BREAKOUT\";\r\ntype StructureLabel = \"BULL\" | \"BEAR\" | \"RANGE\" | \"MIXED\";\r\n\r\ntype SetupSignal = {\r\n  ok: boolean;\r\n  setupType: SetupType;\r\n  structure: StructureLabel;\r\n  confidence: number; // 0..100\r\n  bias: \"LONG\" | \"SHORT\" | \"NONE\";\r\n  entryZone: { lo: number; hi: number; kind: \"market\" | \"limit\" | \"stop\" };\r\n  stop: { price: number; rationale: string };\r\n  targets: Array<{ price: number; sizePct: number; rationale: string }>;\r\n  reasons: string[];\r\n  debug?: any;\r\n};\r\n\r\ntype AnalyzeRequest = {\r\n  symbol: string; // BTCUSDT\r\n  timeframes?: Timeframe[];\r\n  lookback?: number;\r\n  equityUsd?: number;\r\n  persist?: boolean;\r\n\r\n  /** If true: relax gates and allow the model to propose a trade more often (still enforces minRR + risk). */\r\n  aggressive?: boolean;\r\n\r\n  /** Execution mode\r\n   * - HTF: higher-timeframe context + one trade plan (default)\r\n   * - LTF: intraday plan (4h -> 1h -> 15m) + one primary trade plan\r\n   * - FULL: HTF context + intraday plan + one primary trade plan\r\n   */\r\n  mode?: \"HTF\" | \"LTF\" | \"FULL\" | \"LTF_ONLY\";\r\n\r\n  /** Low-timeframe execution plan controls (optional; mode can also enable this) */\r\n  ltfPlan?: {\r\n    enabled?: boolean;\r\n    timeframes?: Array<\"4h\" | \"1h\" | \"15m\">;\r\n    minBars?: number; // minimum available bars per TF to allow LTF execution\r\n  };\r\n\r\n  /** OpenAI overrides (optional) */\r\n  openai?: {\r\n    model?: string;\r\n    temperature?: number;\r\n    maxTokens?: number;\r\n  };\r\n\r\n  constraints?: {\r\n    maxLeverage?: number;\r\n    maxRiskPct?: number;\r\n    minRR?: number;\r\n  };\r\n\r\n  wsProbe?: {\r\n    durationMs?: number;\r\n    maxMessages?: number;\r\n  };\r\n};\r\n\r\n// Supabase numeric often comes back as string\r\ntype NumLike = number | string;\r\n\r\ntype CandleRowRaw = {\r\n  symbol: string;\r\n  timeframe: string;\r\n  open_time: string;\r\n  open: NumLike;\r\n  high: NumLike;\r\n  low: NumLike;\r\n  close: NumLike;\r\n  volume: NumLike;\r\n  buy_volume: NumLike;\r\n  sell_volume: NumLike;\r\n  trades: number;\r\n  ema20: NumLike | null;\r\n  ema50: NumLike | null;\r\n  ema200: NumLike | null;\r\n  rsi14: NumLike | null;\r\n};\r\n\r\ntype CandleRow = {\r\n  symbol: string;\r\n  timeframe: Timeframe;\r\n  open_time: string;\r\n  open: number;\r\n  high: number;\r\n  low: number;\r\n  close: number;\r\n  volume: number;\r\n  buy_volume: number;\r\n  sell_volume: number;\r\n  trades: number;\r\n  ema20: number | null;\r\n  ema50: number | null;\r\n  ema200: number | null;\r\n  rsi14: number | null;\r\n};\r\n\r\ntype ModelPlan = {\r\n  action: \"NO_TRADE\" | \"LONG\" | \"SHORT\";\r\n  leverage: number;\r\n  entry: { type: \"market\" | \"limit\" | \"stop\"; price?: number; trigger?: number };\r\n  stop: { price: number; rationale: string };\r\n  targets: Array<{ price: number; sizePct: number }>;\r\n  riskPct: number;\r\n  notes?: string;\r\n  citations?: Array<{ rule_chunk_id: string }>;\r\n};\r\n\r\ntype IntradayPlan = {\r\n  mode: \"LTF\" | \"FULL\" | \"LTF_ONLY\";\r\n  timeframes: Array<\"4h\" | \"1h\" | \"15m\">;\r\n  bias: \"LONG\" | \"SHORT\" | \"NONE\";\r\n  setupType: SetupType;\r\n  structure: StructureLabel;\r\n  entries: Array<{\r\n    /** usually 15m; 1h allowed for conservative triggers */\r\n    tf: \"15m\" | \"1h\";\r\n    type: \"breakout\" | \"pullback\" | \"reversal\";\r\n    entry: number;\r\n    stop: number;\r\n    targets: Array<{ price: number; sizePct: number }>;\r\n    invalidation: string;\r\n    rr: number;\r\n    notes?: string;\r\n  }>;\r\n  noTradeIf: string[];\r\n  notes?: string;\r\n  citations: Array<{ rule_chunk_id: string }>;\r\n};\r\n\r\ntype TFRegime2 = { label: string; trendScore: number; chopScore: number; reasons: string[] };\r\n\r\ntype TFSummary =\n  | {\n      ok: true;\n      tf: Timeframe;\n      n: number;\r\n      price: number;\r\n      ohlc: { open: number; high: number; low: number; close: number };\r\n      ema: { ema20?: number; ema50?: number; ema200?: number };\r\n      rsi14?: number;\r\n      volume: { total: number; buy: number; sell: number; imbalance: number };\r\n      regime2: TFRegime2;\n    }\n  | { ok: false; tf: Timeframe; n: number; error: string };\n\ntype TfHealth = {\n  tf: Timeframe;\n  n: number;\n  lastOpenTimeMs: number | null;\n  lastAgeMs: number | null;\n  missingBars: number;\n  maxGapMs: number;\n  stale: boolean;\n};\n\ntype DataHealth = {\n  generatedAt: string;\n  timeframes: TfHealth[];\n  missingOrStale: Timeframe[];\n  blocked: boolean;\n};\n\r\ntype GateResult = {\r\n  blocked: boolean;\r\n  reasons: string[];\r\n  higherTimeframesUsed: Timeframe[];\r\n  strongHigherTrend: boolean;\r\n};\r\n\r\n/* ===================== ENV + CLIENTS ===================== */\r\n\r\nfunction requireEnv(name: string): string {\r\n  const v = process.env[name];\r\n  if (!v) throw new Error(`Missing env var: ${name}`);\r\n  return v;\r\n}\r\n\r\nfunction sbAdmin() {\r\n  const url = requireEnv(\"SUPABASE_URL\");\r\n  const key = requireEnv(\"SUPABASE_SERVICE_ROLE_KEY\");\r\n  return createClient(url, key, { auth: { persistSession: false } });\r\n}\r\n\r\nfunction openaiClient() {\r\n  const apiKey = requireEnv(\"OPENAI_API_KEY\");\r\n  return new OpenAI({ apiKey });\r\n}\r\n\r\n/* ===================== SMALL UTILS ===================== */\r\n\r\nfunction clamp(n: number, lo: number, hi: number) {\r\n  if (!Number.isFinite(n)) return lo;\r\n  return Math.min(hi, Math.max(lo, n));\r\n}\r\n\r\nfunction uniq<T>(arr: T[]) {\n  return Array.from(new Set(arr));\n}\n\nfunction normalizeTimeframes(input?: Array<string | null | undefined>): Timeframe[] {\n  if (!Array.isArray(input)) return [];\n  const out: Timeframe[] = [];\n  const seen = new Set<Timeframe>();\n  for (const raw of input) {\n    const tf = String(raw ?? \"\").trim().toLowerCase() as Timeframe;\n    if (!TF_ORDER_INDEX.has(tf)) continue;\n    if (seen.has(tf)) continue;\n    seen.add(tf);\n    out.push(tf);\n  }\n  return out;\n}\n\nfunction sortTimeframes(tfs: Timeframe[]): Timeframe[] {\n  return [...tfs].sort((a, b) => (TF_ORDER_INDEX.get(a) ?? 999) - (TF_ORDER_INDEX.get(b) ?? 999));\n}\n\nfunction safeNum(v: any): number | null {\n  if (v == null) return null;\n  const n = typeof v === \"number\" ? v : Number(v);\n  return Number.isFinite(n) ? n : null;\r\n}\r\n\r\nfunction stripCodeFences(s: string): string {\r\n  const t = (s ?? \"\").trim();\r\n  // ```json ... ``` or ``` ... ```\r\n  const fenced = t.match(/^```(?:json)?\\s*([\\s\\S]*?)\\s*```$/i);\r\n  return fenced ? fenced[1].trim() : t;\r\n}\r\n\r\nfunction extractJsonObject(text: string): string | null {\r\n  const s = stripCodeFences(text)\r\n    .replace(/[\\u201C\\u201D]/g, '\"')\r\n    .replace(/[\\u2018\\u2019]/g, \"'\")\r\n    .trim();\r\n\r\n  // Fast path\r\n  if (s.startsWith(\"{\") && s.endsWith(\"}\")) return s;\r\n\r\n  // Find the outermost {...}\r\n  const first = s.indexOf(\"{\");\r\n  const last = s.lastIndexOf(\"}\");\r\n  if (first >= 0 && last > first) return s.slice(first, last + 1);\r\n\r\n  return null;\r\n}\r\n\r\nasync function repairJsonWithModel(openai: OpenAI, model: string, schemaHint: any, bad: string) {\n  const res: any = await openai.responses.create({\n    model,\n    temperature: 0,\n    max_output_tokens: 1200,\n    instructions:\n      \"You are a strict JSON repair tool. Convert the user's content into ONE valid JSON object that matches the provided schema hint. \" +\n      \"Return ONLY JSON. No markdown, no code fences, no commentary.\",\n    input: JSON.stringify({ schemaHint, bad }),\n  });\n  return String(res.output_text ?? \"\").trim();\n}\n\r\nfunction toPerp(sym: string) {\r\n  // DB stores symbols as perpetual contract tickers like BTCUSDT-PERP.\r\n  // UI may send BTCUSDT. Normalize to the DB convention.\r\n  const s = (sym || \"\").trim().toUpperCase();\r\n  if (!s) return s;\r\n\r\n  // If already in DB form, keep it.\r\n  if (s.endsWith(\"-PERP\")) return s;\r\n\r\n  // Common alternates:\r\n  // BTCUSDT_PERP, BTCUSDT-PERP, BTCUSDT.PERP -> normalize to BTCUSDT-PERP\r\n  const normalized = s.replace(/[_\\. ]?PERP$/i, \"\");\r\n  return normalized + \"-PERP\";\r\n}\r\n\r\nfunction toWsSymbol(dbSymbol: string) {\r\n  // Binance futures WS expects the base symbol without the \"-PERP\" suffix.\r\n  return (dbSymbol || \"\").toLowerCase().replace(/-perp$/i, \"\");\r\n}\r\n\r\nfunction getTfSummary(tfData: TFSummary[], tf: Timeframe) {\r\n  return tfData.find((x) => x.tf === tf && x.ok) as Extract<TFSummary, { ok: true }> | undefined;\r\n}\r\n\r\n/* ===================== DATA ACCESS ===================== */\r\n\r\nasync function fetchCandles(\r\n  sb: ReturnType<typeof sbAdmin>,\r\n  symbolPerp: string,\r\n  tf: Timeframe,\r\n  lookback: number\r\n): Promise<CandleRow[]> {\r\n  const { data, error } = await sb\r\n    .from(\"candles\")\r\n    .select(\"symbol,timeframe,open_time,open,high,low,close,volume,buy_volume,sell_volume,trades,ema20,ema50,ema200,rsi14\")\r\n    .eq(\"symbol\", symbolPerp)\r\n    .eq(\"timeframe\", tf)\r\n    .order(\"open_time\", { ascending: false })\r\n    .limit(lookback);\r\n\r\n  if (error) throw new Error(`candles query failed: ${error.message}`);\r\n\r\n  const rows = (data ?? []) as CandleRowRaw[];\r\n  const normalized: CandleRow[] = rows\r\n    .map((r) => {\r\n      const open = safeNum(r.open);\r\n      const high = safeNum(r.high);\r\n      const low = safeNum(r.low);\r\n      const close = safeNum(r.close);\r\n      const volume = safeNum(r.volume);\r\n      const buy_volume = safeNum(r.buy_volume);\r\n      const sell_volume = safeNum(r.sell_volume);\r\n\r\n      if (open == null || high == null || low == null || close == null || volume == null || buy_volume == null || sell_volume == null) {\r\n        return null;\r\n      }\r\n\r\n      return {\r\n        symbol: r.symbol,\r\n        timeframe: tf,\r\n        open_time: r.open_time,\r\n        open,\r\n        high,\r\n        low,\r\n        close,\r\n        volume,\r\n        buy_volume,\r\n        sell_volume,\r\n        trades: Number(r.trades ?? 0),\r\n        ema20: safeNum(r.ema20),\r\n        ema50: safeNum(r.ema50),\r\n        ema200: safeNum(r.ema200),\r\n        rsi14: safeNum(r.rsi14),\r\n      } as CandleRow;\r\n    })\r\n    .filter((x): x is CandleRow => x != null)\r\n    .reverse(); // oldest -> newest\r\n\r\n  return normalized;\r\n}\r\n\r\nasync function fetchTfCounts(\n  sb: ReturnType<typeof sbAdmin>,\n  symbolPerp: string,\n  tfs: Timeframe[]\n): Promise<Record<string, number>> {\n  const counts: Record<string, number> = {};\r\n\r\n  // Naive approach: count via head query per tf.\r\n  // If you have a materialized counts table, replace this.\r\n  await Promise.all(\r\n    tfs.map(async (tf) => {\r\n      const { count, error } = await sb\r\n        .from(\"candles\")\r\n        .select(\"symbol\", { count: \"exact\", head: true })\r\n        .eq(\"symbol\", symbolPerp)\r\n        .eq(\"timeframe\", tf);\r\n\r\n      if (error) {\r\n        counts[tf] = 0;\r\n        return;\r\n      }\r\n      counts[tf] = Number(count ?? 0);\r\n    })\r\n  );\r\n\r\n  return counts;\n}\n\nasync function fetchNews(\n  sb: ReturnType<typeof sbAdmin>,\n  symbolPerp: string,\n  limit = 6\n): Promise<\n  Array<{ title: string; url: string; source: string | null; published_at: string | null; symbols?: string[] }>\n> {\n  try {\n    const base = symbolPerp.replace(/-PERP$/i, \"\").replace(/USDT$/i, \"\").replace(/USD$/i, \"\");\n    const or = base ? `symbols.cs.{${base}},symbols.cs.{CRYPTO},symbols.cs.{MACRO}` : \"symbols.cs.{CRYPTO}\";\n    const { data, error } = await sb\n      .from(\"market_news\")\n      .select(\"title,url,source,published_at,symbols\")\n      .or(or)\n      .order(\"published_at\", { ascending: false })\n      .limit(limit);\n    if (error || !Array.isArray(data)) return [];\n    return data.map((r: any) => ({\n      title: String(r.title ?? \"\"),\n      url: String(r.url ?? \"\"),\n      source: r.source ?? null,\n      published_at: r.published_at ?? null,\n      symbols: Array.isArray(r.symbols) ? r.symbols : undefined,\n    }));\n  } catch {\n    return [];\n  }\n}\n\nasync function persistDecision(\n  sb: ReturnType<typeof sbAdmin>,\n  payload: {\n    id: string;\n    symbol: string;\n    mode: string;\n    timeframes: Timeframe[];\n    lookback: number;\n    price: number;\n    price_live: number | null;\n    gate: any;\n    setup: any;\n    plan: any;\n    verdict: any;\n    intraday: any;\n    data_health: DataHealth;\n    news: any[];\n  }\n) {\n  try {\n    await sb.from(\"decision_logs\").insert({\n      id: payload.id,\n      symbol: payload.symbol,\n      mode: payload.mode,\n      timeframes: payload.timeframes,\n      lookback: payload.lookback,\n      price: payload.price,\n      price_live: payload.price_live,\n      gate: payload.gate,\n      setup: payload.setup,\n      plan: payload.plan,\n      verdict: payload.verdict,\n      intraday: payload.intraday,\n      data_health: payload.data_health,\n      news: payload.news,\n    });\n  } catch {\n    // ignore if table missing or insert fails\n  }\n}\n\r\n\r\n\r\n/* ===================== CORE CALCS ===================== */\r\n\r\nfunction computeRegime2(tf: Timeframe, rows: CandleRow[]): TFRegime2 {\n  // Simple score proxy: slope vs chop using EMA/RSI + candle overlaps.\r\n  if (rows.length < 50) {\r\n    return { label: \"NA\", trendScore: 0, chopScore: 100, reasons: [\"insufficient_rows\"] };\r\n  }\r\n\r\n  const last = rows[rows.length - 1];\r\n  const ema20 = last.ema20 ?? null;\r\n  const ema50 = last.ema50 ?? null;\r\n  const ema200 = last.ema200 ?? null;\r\n  const rsi = last.rsi14 ?? null;\r\n\r\n  let trendScore = 0;\r\n  let chopScore = 0;\r\n  const reasons: string[] = [];\r\n\r\n  if (ema20 != null && ema50 != null) {\r\n    const sep = Math.abs(ema20 - ema50) / last.close;\r\n    trendScore += clamp(sep * 4000, 0, 50); // 0..50\r\n    reasons.push(`ema20-ema50_sep=${(sep * 100).toFixed(2)}%`);\r\n  } else {\r\n    chopScore += 20;\r\n    reasons.push(\"ema_missing\");\r\n  }\r\n\r\n  if (ema50 != null && ema200 != null) {\r\n    const sep = Math.abs(ema50 - ema200) / last.close;\r\n    trendScore += clamp(sep * 2500, 0, 35);\r\n    reasons.push(`ema50-ema200_sep=${(sep * 100).toFixed(2)}%`);\r\n  }\r\n\r\n  if (rsi != null) {\r\n    const dist = Math.abs(rsi - 50);\r\n    trendScore += clamp(dist * 1.2, 0, 20);\r\n    reasons.push(`rsi_dist=${dist.toFixed(1)}`);\r\n  }\r\n\r\n  // Chop proxy: overlapping bodies/ranges in last N\r\n  const N = 20;\r\n  const tail = rows.slice(-N);\r\n  let overlap = 0;\r\n  for (let i = 1; i < tail.length; i++) {\r\n    const a = tail[i - 1];\r\n    const b = tail[i];\r\n    const lo = Math.max(a.low, b.low);\r\n    const hi = Math.min(a.high, b.high);\r\n    if (hi > lo) overlap++;\r\n  }\r\n  const overlapPct = overlap / Math.max(1, N - 1);\r\n  chopScore += clamp(overlapPct * 100, 0, 80);\r\n  reasons.push(`overlapPct=${(overlapPct * 100).toFixed(0)}%`);\r\n\r\n  // normalize-ish\r\n  trendScore = clamp(trendScore, 0, 100);\r\n  chopScore = clamp(100 - trendScore + chopScore * 0.35, 0, 100);\r\n\r\n  const label =\r\n    trendScore >= 60 && chopScore <= 55 ? \"TREND\" : chopScore >= 65 ? \"CHOP\" : trendScore >= 50 ? \"LEAN_TREND\" : \"MIXED\";\r\n\r\n  return { label, trendScore, chopScore, reasons };\r\n}\r\n\r\nfunction summarize(tf: Timeframe, rows: CandleRow[]): TFSummary {\n  try {\n    if (!rows.length) return { ok: false, tf, n: 0, error: \"no_rows\" };\r\n    const last = rows[rows.length - 1];\r\n    const totalVol = rows.reduce((s, r) => s + r.volume, 0);\r\n    const buy = rows.reduce((s, r) => s + r.buy_volume, 0);\r\n    const sell = rows.reduce((s, r) => s + r.sell_volume, 0);\r\n    const imb = totalVol > 0 ? (buy - sell) / totalVol : 0;\r\n\r\n    return {\r\n      ok: true,\r\n      tf,\r\n      n: rows.length,\r\n      price: last.close,\r\n      ohlc: { open: last.open, high: last.high, low: last.low, close: last.close },\r\n      ema: { ema20: last.ema20 ?? undefined, ema50: last.ema50 ?? undefined, ema200: last.ema200 ?? undefined },\r\n      rsi14: last.rsi14 ?? undefined,\r\n      volume: { total: totalVol, buy, sell, imbalance: imb },\r\n      regime2: computeRegime2(tf, rows),\r\n    };\r\n  } catch (e) {\r\n    return { ok: false, tf, n: rows.length, error: (e as Error)?.message ?? \"summarize_failed\" };\r\n  }\n}\n\nfunction computeATR(rows: CandleRow[], period = 14): number | null {\n  if (rows.length < period + 1) return null;\n  let sum = 0;\n  let count = 0;\n  for (let i = rows.length - period; i < rows.length; i++) {\n    const c = rows[i];\n    const prev = rows[i - 1];\n    if (!prev) continue;\n    const tr = Math.max(c.high - c.low, Math.abs(c.high - prev.close), Math.abs(c.low - prev.close));\n    if (Number.isFinite(tr)) {\n      sum += tr;\n      count += 1;\n    }\n  }\n  return count ? sum / count : null;\n}\n\nfunction buildChopPlan(rows15m: CandleRow[], price: number, constraints: { maxLeverage: number; maxRiskPct: number }): ModelPlan {\n  const lookback = rows15m.slice(-48);\n  if (lookback.length < 24 || !Number.isFinite(price) || price <= 0) {\n    return {\n      action: \"NO_TRADE\",\n      leverage: 1,\n      entry: { type: \"market\" },\n      stop: { price, rationale: \"chop_insufficient_data\" },\n      targets: [{ price, sizePct: 100 }],\n      riskPct: 0,\n      notes: \"chop_mode:insufficient_data\",\n      citations: [],\n    };\n  }\n\n  const hi = Math.max(...lookback.map((r) => r.high));\n  const lo = Math.min(...lookback.map((r) => r.low));\n  const mid = (hi + lo) / 2;\n  const range = hi - lo;\n  const atr = computeATR(rows15m, 14) ?? (range * 0.1);\n  const last = lookback[lookback.length - 1];\n  const rsi = last.rsi14 ?? 50;\n  const avgVol = lookback.reduce((s, r) => s + r.volume, 0) / lookback.length;\n  const volOk = avgVol > 0 ? last.volume >= avgVol * 0.7 : true;\n  const tol = atr * 0.35;\n  const touchesHi = lookback.filter((r) => Math.abs(r.high - hi) <= tol).length;\n  const touchesLo = lookback.filter((r) => Math.abs(r.low - lo) <= tol).length;\n  const rangeValid = touchesHi >= 2 && touchesLo >= 2;\n\n  let action: \"LONG\" | \"SHORT\" | \"NO_TRADE\" = \"NO_TRADE\";\n  if (rangeValid && volOk && price <= lo + range * 0.33 && rsi <= 45) action = \"LONG\";\n  if (rangeValid && volOk && price >= hi - range * 0.33 && rsi >= 55) action = \"SHORT\";\n\n  if (action === \"NO_TRADE\") {\n    return {\n      action: \"NO_TRADE\",\n      leverage: 1,\n      entry: { type: \"market\" },\n      stop: { price, rationale: \"chop_no_edge\" },\n      targets: [{ price, sizePct: 100 }],\n      riskPct: 0,\n      notes: `chop_mode:no_edge range_valid=${rangeValid} vol_ok=${volOk}`,\n      citations: [],\n    };\n  }\n\n  const stop =\n    action === \"LONG\" ? Math.max(0, lo - atr * 0.35) : hi + atr * 0.35;\n  const t1 = action === \"LONG\" ? mid : mid;\n  const t2 = action === \"LONG\" ? hi : lo;\n\n  return {\n    action,\n    leverage: clamp(Math.min(3, constraints.maxLeverage), 1, constraints.maxLeverage),\n    entry: { type: \"market\" },\n    stop: { price: stop, rationale: \"chop_range_stop\" },\n    targets: [\n      { price: t1, sizePct: 60 },\n      { price: t2, sizePct: 40 },\n    ],\n    riskPct: clamp(Math.min(0.6, constraints.maxRiskPct), 0.1, constraints.maxRiskPct),\n    notes: `chop_mode:range hi=${hi.toFixed(1)} lo=${lo.toFixed(1)} rsi=${rsi.toFixed(1)} touches_hi=${touchesHi} touches_lo=${touchesLo} time_stop=6bars`,\n    citations: [],\n  };\n}\n\nfunction computeTfHealth(tf: Timeframe, rows: CandleRow[], nowMs: number): TfHealth {\n  const tfMs = TF_MS[tf];\n  if (!rows.length) {\n    return { tf, n: 0, lastOpenTimeMs: null, lastAgeMs: null, missingBars: 0, maxGapMs: 0, stale: true };\n  }\n\n  let missingBars = 0;\n  let maxGapMs = 0;\n  let prevMs = Date.parse(rows[0].open_time);\n  for (let i = 1; i < rows.length; i++) {\n    const curMs = Date.parse(rows[i].open_time);\n    const diff = curMs - prevMs;\n    if (Number.isFinite(diff) && diff > tfMs * 1.5) {\n      const miss = Math.max(0, Math.round(diff / tfMs) - 1);\n      if (miss > 0) missingBars += miss;\n      if (diff > maxGapMs) maxGapMs = diff;\n    }\n    prevMs = curMs;\n  }\n\n  const lastOpenTimeMs = Date.parse(rows[rows.length - 1].open_time);\n  const lastAgeMs = Number.isFinite(lastOpenTimeMs) ? Math.max(0, nowMs - lastOpenTimeMs) : null;\n  const stale = lastAgeMs != null ? lastAgeMs > tfMs * 2 : true;\n\n  return { tf, n: rows.length, lastOpenTimeMs, lastAgeMs, missingBars, maxGapMs, stale };\n}\n\r\n/* ===================== SETUP DETECTOR (DETERMINISTIC) ===================== */\r\n\r\n\r\n/* ===================== ORDER BLOCKS (DB-DRIVEN) ===================== */\r\n\r\ntype OrderBlock = {\r\n  tf: Timeframe;\r\n  side: \"SUPPLY\" | \"DEMAND\";\r\n  createdTs: string; // open_time of the OB candle\r\n  impulseTs: string; // open_time of the displacement candle\r\n  zoneLo: number;\r\n  zoneHi: number;\r\n  atrAtCreation: number;\r\n  bos: boolean;\r\n  mitigated: boolean;\r\n  touchCount: number;\r\n  invalidated: boolean;\r\n  score: number; // 0..100\r\n};\r\n\r\ntype ObOpts = {\r\n  atrPeriod?: number;\r\n  swingL?: number;\r\n  lookbackForOrigin?: number;\r\n  followN?: number;\r\n  followMin?: number;\r\n  dispMult?: number;\r\n  bodyMin?: number;\r\n  useBodyZone?: boolean;\r\n  bufferAtrPct?: number;\r\n  scoreThreshold?: number;\r\n  maxReturn?: number;\r\n};\r\n\r\nfunction candleBodyRatio(c: { open: number; high: number; low: number; close: number }): number {\r\n  const range = c.high - c.low;\r\n  if (range <= 0) return 0;\r\n  return Math.abs(c.close - c.open) / range;\r\n}\r\n\r\nfunction trueRangeC(c: { high: number; low: number; close: number }, prevClose: number): number {\r\n  const hl = c.high - c.low;\r\n  const hc = Math.abs(c.high - prevClose);\r\n  const lc = Math.abs(c.low - prevClose);\r\n  return Math.max(hl, hc, lc);\r\n}\r\n\r\nfunction atrSMA_rows(rowsAsc: CandleRow[], period = 14): number[] {\r\n  const out = new Array<number>(rowsAsc.length).fill(NaN);\r\n  const tr: number[] = new Array(rowsAsc.length).fill(NaN);\r\n\r\n  for (let i = 0; i < rowsAsc.length; i++) {\r\n    const prevClose = i === 0 ? rowsAsc[i].close : rowsAsc[i - 1].close;\r\n    tr[i] = trueRangeC(rowsAsc[i], prevClose);\r\n    if (i >= period - 1) {\r\n      let sum = 0;\r\n      for (let j = i - (period - 1); j <= i; j++) sum += tr[j];\r\n      out[i] = sum / period;\r\n    }\r\n  }\r\n  return out;\r\n}\r\n\r\nfunction findSwingHighs_rows(rowsAsc: CandleRow[], L: number): boolean[] {\r\n  const swing = new Array<boolean>(rowsAsc.length).fill(false);\r\n  for (let i = L; i < rowsAsc.length - L; i++) {\r\n    const h = rowsAsc[i].high;\r\n    let ok = true;\r\n    for (let k = 1; k <= L; k++) {\r\n      if (rowsAsc[i - k].high >= h) {\r\n        ok = false;\r\n        break;\r\n      }\r\n      if (rowsAsc[i + k].high > h) {\r\n        ok = false;\r\n        break;\r\n      }\r\n    }\r\n    swing[i] = ok;\r\n  }\r\n  return swing;\r\n}\r\n\r\nfunction findSwingLows_rows(rowsAsc: CandleRow[], L: number): boolean[] {\r\n  const swing = new Array<boolean>(rowsAsc.length).fill(false);\r\n  for (let i = L; i < rowsAsc.length - L; i++) {\r\n    const l = rowsAsc[i].low;\r\n    let ok = true;\r\n    for (let k = 1; k <= L; k++) {\r\n      if (rowsAsc[i - k].low <= l) {\r\n        ok = false;\r\n        break;\r\n      }\r\n      if (rowsAsc[i + k].low < l) {\r\n        ok = false;\r\n        break;\r\n      }\r\n    }\r\n    swing[i] = ok;\r\n  }\r\n  return swing;\r\n}\r\n\r\nfunction lastSwingLowBefore_rows(rowsAsc: CandleRow[], swingLows: boolean[], idx: number): number | null {\r\n  for (let i = idx; i >= 0; i--) if (swingLows[i]) return rowsAsc[i].low;\r\n  return null;\r\n}\r\n\r\nfunction lastSwingHighBefore_rows(rowsAsc: CandleRow[], swingHighs: boolean[], idx: number): number | null {\r\n  for (let i = idx; i >= 0; i--) if (swingHighs[i]) return rowsAsc[i].high;\r\n  return null;\r\n}\r\n\r\nfunction isDisplacement_row(\r\n  c: CandleRow,\r\n  atr: number,\r\n  dir: \"UP\" | \"DOWN\",\r\n  dispMult: number,\r\n  bodyMin: number\r\n): boolean {\r\n  if (!Number.isFinite(atr) || atr <= 0) return false;\r\n  const range = c.high - c.low;\r\n  if (range < atr * dispMult) return false;\r\n  if (candleBodyRatio(c) < bodyMin) return false;\r\n  if (dir === \"UP\" && !(c.close > c.open)) return false;\r\n  if (dir === \"DOWN\" && !(c.close < c.open)) return false;\r\n  return true;\r\n}\r\n\r\n/**\r\n * Deterministic Order Block detector:\r\n * - Find displacement candles (range >= ATR*mult + body dominance)\r\n * - Require follow-through (N candles) to avoid single-candle fakes\r\n * - Optional BOS confirmation (break last swing)\r\n * - OB = last opposite candle before displacement\r\n */\r\nfunction detectOrderBlocks(rowsDesc: CandleRow[], tf: Timeframe, opts?: ObOpts): OrderBlock[] {\r\n  const rowsAsc = [...rowsDesc].reverse(); // candles table is fetched DESC; OB detection is easier ASC\r\n  const {\r\n    atrPeriod = 14,\r\n    swingL = tf === \"15m\" ? 2 : 3,\r\n    lookbackForOrigin = tf === \"15m\" ? 5 : tf === \"1h\" ? 7 : 10,\r\n    followN = 2,\r\n    followMin = 1,\r\n    dispMult = tf === \"15m\" ? 1.3 : tf === \"1h\" ? 1.2 : 1.1,\r\n    bodyMin = 0.55,\r\n    useBodyZone = true,\r\n    bufferAtrPct = 0.05,\r\n    scoreThreshold = 65,\r\n    maxReturn = 12,\r\n  } = opts ?? {};\r\n\r\n  if (rowsAsc.length < Math.max(atrPeriod + 10, 60)) return [];\r\n\r\n  const atr = atrSMA_rows(rowsAsc, atrPeriod);\r\n  const swingHighs = findSwingHighs_rows(rowsAsc, swingL);\r\n  const swingLows = findSwingLows_rows(rowsAsc, swingL);\r\n\r\n  const obs: OrderBlock[] = [];\r\n\r\n  for (let d = 0; d < rowsAsc.length; d++) {\r\n    const a = atr[d];\r\n    const cd = rowsAsc[d];\r\n\r\n    const down = isDisplacement_row(cd, a, \"DOWN\", dispMult, bodyMin);\r\n    const up = isDisplacement_row(cd, a, \"UP\", dispMult, bodyMin);\r\n    if (!down && !up) continue;\r\n\r\n    // Follow-through\r\n    let follow = 0;\r\n    let broke = false;\r\n    for (let k = 1; k <= followN && d + k < rowsAsc.length; k++) {\r\n      const ck = rowsAsc[d + k];\r\n      if (down && ck.close < ck.open) follow++;\r\n      if (up && ck.close > ck.open) follow++;\r\n      if (down && ck.low < cd.low) broke = true;\r\n      if (up && ck.high > cd.high) broke = true;\r\n    }\r\n    if (follow < followMin && !broke) continue;\r\n\r\n    // BOS confirmation\r\n    let bos = false;\r\n    if (down) {\r\n      const lastSL = lastSwingLowBefore_rows(rowsAsc, swingLows, d - 1);\r\n      if (lastSL != null && cd.close < lastSL) bos = true;\r\n    } else {\r\n      const lastSH = lastSwingHighBefore_rows(rowsAsc, swingHighs, d - 1);\r\n      if (lastSH != null && cd.close > lastSH) bos = true;\r\n    }\r\n\r\n    // Origin candle (last opposite candle before displacement)\r\n    let obIdx: number | null = null;\r\n    for (let i = d - 1; i >= 0 && i >= d - lookbackForOrigin; i--) {\r\n      const c = rowsAsc[i];\r\n      if (down && c.close > c.open) {\r\n        obIdx = i;\r\n        break; // last bull before dump\r\n      }\r\n      if (up && c.close < c.open) {\r\n        obIdx = i;\r\n        break; // last bear before rally\r\n      }\r\n    }\r\n    if (obIdx == null) continue;\r\n\r\n    const obC = rowsAsc[obIdx];\r\n    const buf = Number.isFinite(a) && a > 0 ? a * bufferAtrPct : 0;\r\n\r\n    let zoneLo: number;\r\n    let zoneHi: number;\r\n    if (useBodyZone) {\r\n      zoneLo = Math.min(obC.open, obC.close) - buf;\r\n      zoneHi = Math.max(obC.open, obC.close) + buf;\r\n    } else {\r\n      zoneLo = obC.low - buf;\r\n      zoneHi = obC.high + buf;\r\n    }\r\n\r\n    // Mitigation + invalidation\r\n    let touchCount = 0;\r\n    let mitigated = false;\r\n    let invalidated = false;\r\n\r\n    for (let j = obIdx + 1; j < rowsAsc.length; j++) {\r\n      const cj = rowsAsc[j];\r\n      const touched = cj.high >= zoneLo && cj.low <= zoneHi;\r\n      if (touched) {\r\n        touchCount++;\r\n        mitigated = true;\r\n      }\r\n      if (down && cj.close > zoneHi + buf) {\r\n        invalidated = true;\r\n        break;\r\n      }\r\n      if (up && cj.close < zoneLo - buf) {\r\n        invalidated = true;\r\n        break;\r\n      }\r\n    }\r\n\r\n    // Score (0..100)\r\n    const dispStrength = Math.min(1, (cd.high - cd.low) / (a * dispMult)); // 0..1+\r\n    const body = candleBodyRatio(cd);\r\n    let score = 0;\r\n    score += 40 * dispStrength;\r\n    score += 25 * Math.min(1, body / bodyMin);\r\n    score += bos ? 20 : 0;\r\n    score += !mitigated ? 10 : touchCount === 1 ? 5 : 0;\r\n    score -= invalidated ? 50 : 0;\r\n\r\n    score = Math.max(0, Math.min(100, Math.round(score)));\r\n\r\n    if (score < scoreThreshold || invalidated) continue;\r\n\r\n    obs.push({\r\n      tf,\r\n      side: down ? \"SUPPLY\" : \"DEMAND\",\r\n      createdTs: obC.open_time,\r\n      impulseTs: cd.open_time,\r\n      zoneLo,\r\n      zoneHi,\r\n      atrAtCreation: Number.isFinite(a) ? a : 0,\r\n      bos,\r\n      mitigated,\r\n      touchCount,\r\n      invalidated,\r\n      score,\r\n    });\r\n  }\r\n\r\n  // Keep the most relevant / highest quality\r\n  obs.sort((a, b) => b.score - a.score);\r\n  return obs.slice(0, maxReturn);\r\n}\r\n\r\nfunction detectSetup(input: { tf15m: CandleRow[]; tf1h: CandleRow[]; tf4h: CandleRow[]; price: number }): SetupSignal {\r\n  const { tf15m, tf1h, tf4h, price } = input;\r\n\r\n  // Minimal strict detector: aligns EMA slope and RSI in 1h/4h + 15m trigger zone.\r\n  // You can replace with your rulebook engine later; this is intentionally tight.\r\n  const reasons: string[] = [];\r\n  const last15 = tf15m.at(-1);\r\n  const last1h = tf1h.at(-1);\r\n  const last4h = tf4h.at(-1);\r\n\r\n  if (!last15 || !last1h || !last4h) {\r\n    return {\r\n      ok: false,\r\n      setupType: \"NONE\",\r\n      structure: \"MIXED\",\r\n      confidence: 0,\r\n      bias: \"NONE\",\r\n      entryZone: { lo: price, hi: price, kind: \"market\" },\r\n      stop: { price, rationale: \"missing_tf_rows\" },\r\n      targets: [] as SetupSignal[\"targets\"],\r\n      reasons: [\"missing_tf_rows\"],\r\n    };\r\n  }\r\n\r\n  const emaUp = (r: CandleRow) => (r.ema20 != null && r.ema50 != null ? r.ema20 > r.ema50 : false);\r\n  const emaDn = (r: CandleRow) => (r.ema20 != null && r.ema50 != null ? r.ema20 < r.ema50 : false);\r\n\r\n  const rsi = (r: CandleRow) => (r.rsi14 != null ? r.rsi14 : 50);\r\n\r\n  const bias =\r\n    emaUp(last4h) && emaUp(last1h) && rsi(last1h) >= 52\r\n      ? \"LONG\"\r\n      : emaDn(last4h) && emaDn(last1h) && rsi(last1h) <= 48\r\n        ? \"SHORT\"\r\n        : \"NONE\";\r\n\r\n  if (bias === \"NONE\") {\r\n    reasons.push(\"ema_rsi_not_aligned\");\r\n    return {\r\n      ok: false,\r\n      setupType: \"NONE\",\r\n      structure: \"MIXED\",\r\n      confidence: 45,\r\n      bias: \"NONE\",\r\n      entryZone: { lo: price, hi: price, kind: \"market\" },\r\n      stop: { price, rationale: \"no_alignment\" },\r\n      targets: [] as SetupSignal[\"targets\"],\r\n      reasons,\r\n    };\r\n  }\r\n\r\n  // Simple pullback zone around 15m ema20\r\n  const e20 = last15.ema20 ?? price;\r\n  const zonePct = 0.12;\r\n  const zone = bias === \"LONG\" ? { lo: e20 * (1 - zonePct / 100), hi: e20 * (1 + zonePct / 100) } : { lo: e20 * (1 - zonePct / 100), hi: e20 * (1 + zonePct / 100) };\r\n\r\n  const stop = bias === \"LONG\" ? Math.min(last15.low, last1h.low) : Math.max(last15.high, last1h.high);\r\n  const t1 = bias === \"LONG\" ? price * 1.01 : price * 0.99;\r\n  const t2 = bias === \"LONG\" ? price * 1.02 : price * 0.98;\r\n\r\n  const confidence = 60 + Math.min(30, Math.abs(rsi(last1h) - 50));\r\n  reasons.push(`bias=${bias}`);\r\n  reasons.push(`rsi1h=${rsi(last1h).toFixed(1)}`);\r\n\r\n  return {\r\n    ok: true,\r\n    setupType: \"PULLBACK\",\r\n    structure: bias === \"LONG\" ? \"BULL\" : \"BEAR\",\r\n    confidence: clamp(confidence, 0, 100),\r\n    bias,\r\n    entryZone: { lo: zone.lo, hi: zone.hi, kind: \"limit\" },\r\n    stop: { price: stop, rationale: \"below/above recent swing lows/highs (15m+1h)\" },\r\n    targets: [\r\n      { price: t1, sizePct: 50, rationale: \"T1 small extension\" },\r\n      { price: t2, sizePct: 50, rationale: \"T2 extension\" },\r\n    ],\r\n    reasons,\r\n    debug: { ema20_15m: last15.ema20, ema50_15m: last15.ema50, ema20_1h: last1h.ema20, ema50_1h: last1h.ema50 },\r\n  };\r\n}\r\n\r\n/* ===================== LIVE WS PROBE ===================== */\r\n\r\nasync function binanceProbe(symbolPerp: string, durationMs: number, maxMessages: number) {\n  const streamSymbol = toWsSymbol(symbolPerp);\n  const url = `wss://fstream.binance.com/ws/${streamSymbol}@trade`;\n\n  return new Promise<{\n    ok: boolean;\n    messages: number;\n    interArrival: { p50: number; p95: number; p99: number };\n    flow: { buy: number; sell: number; imbalance: number };\n    sampleMs: number;\n    lastPrice?: number;\n    lastTs?: number;\n    error?: string;\n  }>((resolve) => {\n    const ws = new WebSocket(url);\n    const times: number[] = [];\n    let messages = 0;\n    let buy = 0;\n    let sell = 0;\n    let lastPrice: number | undefined;\n    let lastTs: number | undefined;\n\n    const started = Date.now();\n\r\n    const finish = (err?: string) => {\r\n      try {\r\n        ws.close();\r\n      } catch {}\r\n      const sampleMs = Date.now() - started;\r\n\r\n      const diffs: number[] = [];\r\n      for (let i = 1; i < times.length; i++) diffs.push(times[i] - times[i - 1]);\r\n      diffs.sort((a, b) => a - b);\r\n\r\n      const p = (q: number) => {\r\n        if (!diffs.length) return 0;\r\n        const idx = Math.min(diffs.length - 1, Math.floor(q * diffs.length));\r\n        return diffs[idx];\r\n      };\r\n\r\n      const total = buy + sell;\r\n      const imbalance = total > 0 ? (buy - sell) / total : 0;\r\n\r\n      resolve({\n        ok: !err,\n        messages,\n        interArrival: { p50: p(0.5), p95: p(0.95), p99: p(0.99) },\n        flow: { buy, sell, imbalance },\n        sampleMs,\n        lastPrice,\n        lastTs,\n        error: err,\n      });\n    };\n\r\n    const timer = setTimeout(() => finish(), durationMs);\r\n\r\n    ws.on(\"message\", (msg) => {\r\n      if (messages >= maxMessages) {\r\n        clearTimeout(timer);\r\n        return finish();\r\n      }\r\n      messages++;\r\n      const now = Date.now();\r\n      times.push(now);\r\n\r\n      try {\n        const j = JSON.parse(msg.toString());\n        const qty = Number(j.q ?? 0);\n        const isMaker = Boolean(j.m); // maker is seller in Binance trade stream\n        const p = Number(j.p);\n        const ts = Number(j.T);\n        if (Number.isFinite(p)) lastPrice = p;\n        if (Number.isFinite(ts)) lastTs = ts;\n        if (isMaker) sell += qty;\n        else buy += qty;\n      } catch {\n        // ignore parse errors\r\n      }\r\n    });\r\n\r\n    ws.on(\"error\", (e) => {\r\n      clearTimeout(timer);\r\n      finish((e as Error)?.message ?? \"ws_error\");\r\n    });\r\n\r\n    ws.on(\"close\", () => {\r\n      clearTimeout(timer);\r\n      finish();\r\n    });\r\n  });\r\n}\r\n\r\n/* ===================== REGIME GATE ===================== */\r\n\r\nfunction buildRegimeGate(tfData: TFSummary[], tfCounts: Record<string, number>): GateResult {\r\n  const reasons: string[] = [];\r\n\r\n  // Choose HTF: prefer 1d if enough data, else 12h.\r\n  const useDaily = (tfCounts[\"1d\"] ?? 0) >= 120;\r\n  const htfs: Timeframe[] = useDaily ? [\"1d\", \"4h\"] : [\"12h\", \"4h\"];\r\n\r\n  const htfSummaries = htfs.map((tf) => getTfSummary(tfData, tf)).filter(Boolean) as Array<Extract<TFSummary, { ok: true }>>;\r\n  if (htfSummaries.length < 2) {\r\n    return { blocked: true, reasons: [\"missing_htf\"], higherTimeframesUsed: htfs, strongHigherTrend: false };\r\n  }\r\n\r\n  // Hard gate: if HTF chop is high, block.\r\n  const htfChop = htfSummaries.map((s) => s.regime2.chopScore);\r\n  const avgChop = htfChop.reduce((a, b) => a + b, 0) / htfChop.length;\r\n\r\n  if (avgChop >= 70) reasons.push(`htf_chop_high:${avgChop.toFixed(0)}`);\r\n\r\n  // Strong trend if trendScore high and chop low.\r\n  const avgTrend = htfSummaries.map((s) => s.regime2.trendScore).reduce((a, b) => a + b, 0) / htfSummaries.length;\r\n  const strongHigherTrend = avgTrend >= 65 && avgChop <= 60;\r\n\r\n  if (!strongHigherTrend) reasons.push(`htf_not_strong_trend:t=${avgTrend.toFixed(0)} c=${avgChop.toFixed(0)}`);\r\n\r\n  const blocked = reasons.length > 0 && !strongHigherTrend;\r\n\r\n  return { blocked, reasons, higherTimeframesUsed: htfs, strongHigherTrend };\r\n}\r\n\r\n/* ===================== RAG RULE RETRIEVAL ===================== */\r\n\r\nasync function retrieveRules(openai: OpenAI, sb: ReturnType<typeof sbAdmin>, query: string) {\r\n  // 1) embed query\r\n  const emb = await openai.embeddings.create({\r\n    model: process.env.OPENAI_EMBED_MODEL || \"text-embedding-3-small\",\r\n    input: query,\r\n  });\r\n\r\n  const v = emb.data?.[0]?.embedding;\r\n  if (!v || !Array.isArray(v)) throw new Error(\"Embedding failed\");\r\n\r\n  // 2) vector search via RPC\r\n  const { data, error } = await sb.rpc(\"match_rule_chunks\", {\r\n    query_embedding: v,\r\n    match_count: 14,\r\n    doc_names: null,      // optionally: [\"RealDayTrading Wiki May 2024\", ...]\r\n    chunk_types: null,    // optionally: [\"entry\", \"risk\", \"pattern\"]\r\n  });\r\n\r\n  if (error) throw new Error(`match_rule_chunks failed: ${error.message}`);\r\n  return data ?? [];\r\n}\r\n\r\n\r\n/* ===================== OPENAI PLAN CALL ===================== */\r\n\r\nasync function callModel(\r\n  openai: OpenAI,\r\n  snapshot: any,\r\n  rules: any,\r\n  constraints: any,\r\n  opts: {\r\n    mode: \"HTF\" | \"LTF\" | \"FULL\" | \"LTF_ONLY\";\r\n    ltfTimeframes: Array<\"4h\" | \"1h\" | \"15m\">;\r\n    openai?: { model?: string; temperature?: number; maxTokens?: number };\r\n  }\r\n): Promise<ModelPlan & { intraday?: IntradayPlan }> {\r\n  const model = opts.openai?.model || process.env.OPENAI_TRADE_MODEL || \"gpt-4o-mini\";\n  const temperature = clamp(Number(opts.openai?.temperature ?? 0.15), 0, 1);\n  const maxTokens = clamp(Number(opts.openai?.maxTokens ?? 900), 256, 2000);\n\r\n  const wantIntraday = opts.mode === \"LTF\" || opts.mode === \"FULL\" || opts.mode === \"LTF_ONLY\";\r\n\r\n  const jsonSchema: any = {\n    name: \"trade_plan\",\n    strict: true,\n    schema: {\n      type: \"object\",\r\n      additionalProperties: false,\r\n      properties: {\r\n        action: { type: \"string\", enum: [\"NO_TRADE\", \"LONG\", \"SHORT\"] },\r\n        leverage: { type: \"number\" },\r\n        entry: {\r\n          type: \"object\",\r\n          additionalProperties: false,\r\n          properties: {\r\n            type: { type: \"string\", enum: [\"market\", \"limit\", \"stop\"] },\r\n            price: { type: \"number\" },\r\n            trigger: { type: \"number\" },\r\n          },\r\n          required: [\"type\"],\r\n        },\r\n        stop: {\r\n          type: \"object\",\r\n          additionalProperties: false,\r\n          properties: {\r\n            price: { type: \"number\" },\r\n            rationale: { type: \"string\" },\r\n          },\r\n          required: [\"price\", \"rationale\"],\r\n        },\r\n        targets: {\r\n          type: \"array\",\r\n          items: {\r\n            type: \"object\",\r\n            additionalProperties: false,\r\n            properties: { price: { type: \"number\" }, sizePct: { type: \"number\" } },\r\n            required: [\"price\", \"sizePct\"],\r\n          },\r\n          minItems: 1,\r\n        },\r\n        riskPct: { type: \"number\" },\r\n        notes: { type: \"string\" },\r\n        citations: {\r\n          type: \"array\",\r\n          items: {\r\n            type: \"object\",\r\n            additionalProperties: false,\r\n            properties: { rule_chunk_id: { type: \"string\" } },\r\n            required: [\"rule_chunk_id\"],\r\n          },\r\n        },\r\n        intraday: wantIntraday\r\n          ? {\r\n              type: \"object\",\r\n              additionalProperties: false,\r\n              properties: {\r\n                mode: { type: \"string\", enum: [\"LTF\", \"FULL\", \"LTF_ONLY\"] },\r\n                timeframes: {\r\n                  type: \"array\",\r\n                  items: { type: \"string\", enum: [\"4h\", \"1h\", \"15m\"] },\r\n                  minItems: 1,\r\n                },\r\n                bias: { type: \"string\", enum: [\"LONG\", \"SHORT\", \"NONE\"] },\r\n                setupType: { type: \"string\", enum: [\"NONE\", \"TREND_CONTINUATION\", \"PULLBACK\", \"BREAKOUT\"] },\r\n                structure: { type: \"string\", enum: [\"BULL\", \"BEAR\", \"RANGE\", \"MIXED\"] },\r\n                entries: {\r\n                  type: \"array\",\r\n                  items: {\r\n                    type: \"object\",\r\n                    additionalProperties: false,\r\n                    properties: {\r\n                      tf: { type: \"string\", enum: [\"15m\", \"1h\"] },\r\n                      type: { type: \"string\", enum: [\"breakout\", \"pullback\", \"reversal\"] },\r\n                      entry: { type: \"number\" },\r\n                      stop: { type: \"number\" },\r\n                      targets: {\r\n                        type: \"array\",\r\n                        items: {\r\n                          type: \"object\",\r\n                          additionalProperties: false,\r\n                          properties: { price: { type: \"number\" }, sizePct: { type: \"number\" } },\r\n                          required: [\"price\", \"sizePct\"],\r\n                        },\r\n                        minItems: 1,\r\n                      },\r\n                      invalidation: { type: \"string\" },\r\n                      rr: { type: \"number\" },\r\n                      notes: { type: \"string\" },\r\n                    },\r\n                    required: [\"tf\", \"type\", \"entry\", \"stop\", \"targets\", \"invalidation\", \"rr\"],\r\n                  },\r\n                },\r\n                noTradeIf: { type: \"array\", items: { type: \"string\" } },\r\n                notes: { type: \"string\" },\r\n                citations: {\r\n                  type: \"array\",\r\n                  items: {\r\n                    type: \"object\",\r\n                    additionalProperties: false,\r\n                    properties: { rule_chunk_id: { type: \"string\" } },\r\n                    required: [\"rule_chunk_id\"],\r\n                  },\r\n                },\r\n              },\r\n              required: [\"mode\", \"timeframes\", \"bias\", \"setupType\", \"structure\", \"entries\", \"noTradeIf\", \"citations\"],\r\n            }\r\n          : undefined,\r\n      },\r\n      required: [\"action\", \"leverage\", \"entry\", \"stop\", \"targets\", \"riskPct\", \"citations\"],\r\n    },\r\n  };\r\n\r\n  const system =\r\n  \"You are a rules-driven trading engine. You MUST follow the retrieved rules and the deterministic gates. \" +\r\n  \"You MUST NOT invent indicators or external prices. Only use prices/levels from snapshot candle data. \" +\r\n  \"If rules conflict or the setup is unclear, return action=NO_TRADE. \" +\r\n  (snapshot?.gate?.blocked && opts.mode === \"LTF_ONLY\"\r\n    ? \"HTF regime gate is BLOCKED, but it is BYPASSED for LTF_ONLY mode. You may trade ONLY if LTF execution rules are satisfied with clear invalidation and RR. \"\r\n    : \"\") +\r\n  \"If action is LONG/SHORT you MUST include at least 2 citations with rule_chunk_id from provided rules. \" +\r\n  (wantIntraday ? \"Also produce intraday execution entries for 4h->1h->15m...\" : \"\");\r\n\r\n\r\n  const payload = {\n    snapshot,\n    constraints,\n    mode: opts.mode,\n    ltfTimeframes: opts.ltfTimeframes,\n    rules,\n  };\n\n  let content = \"\";\n  try {\n    const res: any = await openai.responses.create({\n      model,\n      temperature,\n      max_output_tokens: maxTokens,\n      instructions: system,\n      input: JSON.stringify(payload),\n      text: {\n        format: {\n          type: \"json_schema\",\n          name: jsonSchema.name,\n          schema: jsonSchema.schema,\n          strict: true,\n        },\n      },\n    });\n\n    content = String(res.output_text ?? \"\");\n  } catch {\n    // Fallback for older models/accounts that don't support json_schema\n    const res: any = await openai.responses.create({\n      model,\n      temperature,\n      max_output_tokens: maxTokens,\n      instructions: system + \" Return ONLY valid JSON.\",\n      input: JSON.stringify({\n        ...payload,\n        format_hint: \"json\",\n        schema_hint: {\n          action: \"NO_TRADE|LONG|SHORT\",\n          leverage: \"number\",\n          entry: { type: \"market|limit|stop\", price: \"number?\", trigger: \"number?\" },\n          stop: { price: \"number\", rationale: \"string\" },\n          targets: [{ price: \"number\", sizePct: \"number\" }],\n          riskPct: \"number\",\n          notes: \"string?\",\n          citations: [{ rule_chunk_id: \"string\" }],\n          intraday: wantIntraday ? \"{...}\" : undefined,\n        },\n      }),\n      text: { format: { type: \"json_object\" } },\n    });\n    content = String(res.output_text ?? \"\");\n  }\n\r\n  \r\ntry {\r\n    const extracted = extractJsonObject(content);\r\n    if (!extracted) throw new Error(\"no_json_object\");\r\n    return JSON.parse(extracted);\r\n  } catch {\r\n    // One repair attempt (common failure: markdown fences, trailing text)\r\n    try {\r\n      const repaired = await repairJsonWithModel(openai, model, (jsonSchema as any)?.schema ?? {}, content);\r\n      const extracted2 = extractJsonObject(repaired);\r\n      if (!extracted2) throw new Error(\"repair_no_json_object\");\r\n      return JSON.parse(extracted2);\r\n    } catch {\r\n    return {\r\n      action: \"NO_TRADE\",\r\n      leverage: 1,\r\n      entry: { type: \"market\" },\r\n      stop: { price: snapshot?.price ?? 0, rationale: \"Model returned invalid JSON.\" },\r\n      targets: [{ price: snapshot?.price ?? 0, sizePct: 100 }],\r\n      riskPct: 0,\r\n      notes: \"Invalid JSON from model.\",\r\n      citations: [],\r\n    };\r\n    }\r\n  }\r\n}\r\n\r\n/* ===================== VALIDATION ===================== */\r\n\r\nfunction validate(plan: ModelPlan, constraints: { maxLeverage: number; maxRiskPct: number; minRR: number }, price: number) {\r\n  const reasons: string[] = [];\r\n\r\n  plan.leverage = clamp(Number(plan.leverage), 1, constraints.maxLeverage);\r\n  plan.riskPct = clamp(Number(plan.riskPct), 0, constraints.maxRiskPct);\r\n\r\n  if (plan.action === \"NO_TRADE\") {\r\n    return { ok: true, reasons, rr: null as number | null };\r\n  }\r\n\r\n  const cites = plan.citations ?? [];\r\n  if (cites.length < 2) reasons.push(\"missing_rule_citations\");\r\n\r\n  const entry = plan.entry?.type === \"market\" ? price : Number(plan.entry?.price ?? plan.entry?.trigger);\r\n  const stop = Number(plan.stop?.price);\r\n  const t1 = Number(plan.targets?.[0]?.price);\r\n\r\n  if (!Number.isFinite(entry) || entry <= 0) reasons.push(\"invalid_entry\");\r\n  if (!Number.isFinite(stop) || stop <= 0) reasons.push(\"invalid_stop\");\r\n  if (!Number.isFinite(t1) || t1 <= 0) reasons.push(\"invalid_target_1\");\r\n  if (reasons.length) return { ok: false, reasons, rr: null as number | null };\r\n\r\n  if (plan.action === \"LONG\" && stop >= entry) reasons.push(\"long_stop_not_below_entry\");\r\n  if (plan.action === \"SHORT\" && stop <= entry) reasons.push(\"short_stop_not_above_entry\");\r\n\r\n  const stopDist = Math.abs(entry - stop);\r\n  if (stopDist <= 0) reasons.push(\"zero_stop_distance\");\r\n\r\n  const minStopPct = 0.15;\r\n  if ((stopDist / entry) * 100 < minStopPct) reasons.push(\"stop_too_tight\");\r\n\r\n  const rr = stopDist > 0 ? Math.abs(t1 - entry) / stopDist : 0;\r\n  if (!Number.isFinite(rr) || rr <= 0) reasons.push(\"invalid_rr\");\r\n  if (rr < constraints.minRR) reasons.push(\"rr_too_low\");\r\n\r\n  return { ok: reasons.length === 0, reasons, rr };\r\n}\r\n\r\nfunction validateIntraday(\r\n  intraday: IntradayPlan | undefined,\r\n  constraints: { maxRiskPct: number; minRR: number },\r\n  price: number\r\n) {\r\n  if (!intraday) return { ok: true, reasons: [] as string[], entries: [] as any[] };\r\n\r\n  const reasons: string[] = [];\r\n  const entries = (intraday.entries ?? []).map((e) => {\r\n    const entry = Number(e.entry);\r\n    const stop = Number(e.stop);\r\n    const t1 = Number(e.targets?.[0]?.price);\r\n    const stopDist = Math.abs(entry - stop);\r\n    const rr = stopDist > 0 ? Math.abs(t1 - entry) / stopDist : 0;\r\n    return { ...e, rrComputed: rr };\r\n  });\r\n\r\n  if (!entries.length) reasons.push(\"intraday_no_entries\");\r\n\r\n  for (const e of entries) {\r\n    if (!Number.isFinite(e.entry) || e.entry <= 0) reasons.push(\"intraday_invalid_entry\");\r\n    if (!Number.isFinite(e.stop) || e.stop <= 0) reasons.push(\"intraday_invalid_stop\");\r\n    if (!Number.isFinite(e.rrComputed) || e.rrComputed <= 0) reasons.push(\"intraday_invalid_rr\");\r\n    if (e.rrComputed < constraints.minRR) reasons.push(\"intraday_rr_too_low\");\r\n    const minStopPct = 0.12; // slightly looser for LTF\r\n    const stopDist = Math.abs(e.entry - e.stop);\r\n    if (Number.isFinite(e.entry) && e.entry > 0 && (stopDist / e.entry) * 100 < minStopPct) reasons.push(\"intraday_stop_too_tight\");\r\n  }\r\n\r\n  // soft check: intraday prices should be near current price (avoid nonsense far away)\r\n  const maxDriftPct = 8;\r\n  for (const e of entries) {\r\n    const drift = (Math.abs(Number(e.entry) - price) / price) * 100;\r\n    if (Number.isFinite(drift) && drift > maxDriftPct) reasons.push(\"intraday_entry_too_far_from_price\");\r\n  }\r\n\r\n  return { ok: reasons.length === 0, reasons, entries };\r\n}\r\n\r\n\r\ntype ExecutionSizing = {\r\n  equityUsd: number;\r\n  leverage: number;\r\n  entryPrice: number;\r\n  stopPrice: number;\r\n  side: \"LONG\" | \"SHORT\";\r\n  maxNotionalUsd: number;\r\n  qty: number; // base asset quantity\r\n  notionalUsd: number;\r\n  effectiveLeverage: number;\r\n  riskPct: number;\r\n  riskUsdPlanned: number;\r\n  riskUsdActual: number;\r\n  stopDistance: number;\r\n  expected: Array<{ targetPrice: number; sizePct: number; pnlUsd: number; rr: number }>;\r\n  notes: string[];\r\n};\r\n\r\nfunction computeExecutionSizing(\r\n  plan: ModelPlan,\r\n  price: number,\r\n  equityUsd: number\r\n): ExecutionSizing | null {\r\n  if (plan.action === \"NO_TRADE\") return null;\r\n\r\n  const notes: string[] = [];\r\n  const side = plan.action;\r\n\r\n  const entryPrice =\r\n    plan.entry?.type === \"market\"\r\n      ? price\r\n      : Number(plan.entry?.price ?? plan.entry?.trigger);\r\n\r\n  const stopPrice = Number(plan.stop?.price);\r\n\r\n  if (!Number.isFinite(entryPrice) || entryPrice <= 0) return null;\r\n  if (!Number.isFinite(stopPrice) || stopPrice <= 0) return null;\r\n\r\n  const stopDistance = Math.abs(entryPrice - stopPrice);\r\n  if (!Number.isFinite(stopDistance) || stopDistance <= 0) return null;\r\n\r\n  const riskPct = clamp(Number(plan.riskPct), 0, 100);\r\n  const riskUsdPlanned = Math.max(0, (equityUsd * riskPct) / 100);\r\n\r\n  const leverage = clamp(Number(plan.leverage), 1, 100);\r\n  const maxNotionalUsd = Math.max(0, equityUsd * leverage);\r\n\r\n  // qty sizing: constrained by risk AND leverage cap\r\n  const qtyByRisk = riskUsdPlanned > 0 ? riskUsdPlanned / stopDistance : 0;\r\n  const qtyByLev = maxNotionalUsd > 0 ? maxNotionalUsd / entryPrice : 0;\r\n\r\n  let qty = Math.min(qtyByRisk, qtyByLev);\r\n\r\n  if (!Number.isFinite(qty) || qty <= 0) {\r\n    notes.push(\"position_size_zero_or_invalid\");\r\n    return {\r\n      equityUsd,\r\n      leverage,\r\n      entryPrice,\r\n      stopPrice,\r\n      side,\r\n      maxNotionalUsd,\r\n      qty: 0,\r\n      notionalUsd: 0,\r\n      effectiveLeverage: 0,\r\n      riskPct,\r\n      riskUsdPlanned,\r\n      riskUsdActual: 0,\r\n      stopDistance,\r\n      expected: [],\r\n      notes,\r\n    };\r\n  }\r\n\r\n  const notionalUsd = qty * entryPrice;\r\n  const effectiveLeverage = equityUsd > 0 ? notionalUsd / equityUsd : 0;\r\n  const riskUsdActual = qty * stopDistance;\r\n\r\n  // normalize target sizing to 100%\r\n  const targets = Array.isArray(plan.targets) ? plan.targets : [];\r\n  const sumPct = targets.reduce((acc, t) => acc + (Number(t.sizePct) || 0), 0);\r\n  const normTargets =\r\n    sumPct > 0\r\n      ? targets.map((t) => ({ price: Number(t.price), sizePct: ((Number(t.sizePct) || 0) / sumPct) * 100 }))\r\n      : targets.map((t, i) => ({ price: Number(t.price), sizePct: i === 0 ? 100 : 0 }));\r\n\r\n  const expected = normTargets\r\n    .filter((t) => Number.isFinite(t.price) && t.price > 0 && Number.isFinite(t.sizePct) && t.sizePct > 0)\r\n    .map((t) => {\r\n      const move = Math.abs(Number(t.price) - entryPrice);\r\n      const rr = stopDistance > 0 ? move / stopDistance : 0;\r\n      // PnL for linear perp: qty * price move * signed direction * (sizePct portion)\r\n      const dir = side === \"LONG\" ? 1 : -1;\r\n      const pnlPerUnit = (Number(t.price) - entryPrice) * dir;\r\n      const pnlUsd = qty * pnlPerUnit * (Number(t.sizePct) / 100);\r\n      return { targetPrice: Number(t.price), sizePct: Number(t.sizePct), pnlUsd, rr };\r\n    });\r\n\r\n  if (effectiveLeverage > leverage + 1e-9) notes.push(\"effective_leverage_exceeds_requested\");\r\n  if (notionalUsd > maxNotionalUsd + 1e-6) notes.push(\"notional_exceeds_leverage_cap\");\r\n\r\n  return {\r\n    equityUsd,\r\n    leverage,\r\n    entryPrice,\r\n    stopPrice,\r\n    side,\r\n    maxNotionalUsd,\r\n    qty,\r\n    notionalUsd,\r\n    effectiveLeverage,\r\n    riskPct,\r\n    riskUsdPlanned,\r\n    riskUsdActual,\r\n    stopDistance,\r\n    expected,\r\n    notes,\r\n  };\r\n}\r\n\r\n/* ===================== HANDLER ===================== */\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = (await req.json()) as AnalyzeRequest;\r\n\r\n    const raw = (body.symbol || \"\").trim().toUpperCase();\r\n    if (!raw) return NextResponse.json({ ok: false, error: \"symbol is required\" }, { status: 400 });\r\n\r\n    const symbol = toPerp(raw);\r\n\r\n    const mode: \"HTF\" | \"LTF\" | \"FULL\" | \"LTF_ONLY\" =\r\n      body.mode ?? (body.ltfPlan?.enabled ? \"LTF\" : \"HTF\");\r\n\r\n    let ltfTimeframes = normalizeTimeframes(body.ltfPlan?.timeframes as Array<string> | undefined).filter(\n      (tf) => tf === \"4h\" || tf === \"1h\" || tf === \"15m\"\n    ) as Array<\"4h\" | \"1h\" | \"15m\">;\n    if (!ltfTimeframes.length) ltfTimeframes = [\"4h\", \"1h\", \"15m\"];\n\r\n    const runLtf = mode === \"LTF\" || mode === \"FULL\" || mode === \"LTF_ONLY\";\r\n    const aggressive = Boolean(body.aggressive);\r\n\r\n    const bypassHtfGate = mode === \"LTF_ONLY\" || aggressive;\r\n\r\n    // user requested timeframes (default: the ones your UI expects)\r\n    const requestedInput = normalizeTimeframes(body.timeframes as Array<string> | undefined);\n    const requestedTfs: Timeframe[] = requestedInput.length ? requestedInput : (runLtf ? [\"15m\", \"1h\", \"4h\"] : [\"15m\", \"1h\", \"4h\", \"1d\"]);\n\r\n    // summary lookback (for snapshot / regime classifier)\r\n    const lookbackSummary = clamp(body.lookback ?? 300, 80, 1500);\r\n\r\n    // setup detector needs more; don't depend on user passing 200+\r\n    const lookbackSetup = Math.max(260, lookbackSummary);\r\n\r\n    const equity = Number.isFinite(Number(body.equityUsd)) ? Number(body.equityUsd) : 100;\r\n\r\n    const constraints = {\n      maxLeverage: clamp(Number(body.constraints?.maxLeverage ?? 10), 1, 10),\n      maxRiskPct: clamp(Number(body.constraints?.maxRiskPct ?? 1), 0.1, 5),\n      minRR: clamp(Number(body.constraints?.minRR ?? 1.8), 1, 5),\n    };\n    const persist = Boolean(body.persist);\n\r\n    const sb = sbAdmin();\r\n\r\n    // counts first (adaptive HTF choice depends on 1D count)\r\n    const tfCounts = await fetchTfCounts(sb, symbol, [\"1d\", \"12h\", \"4h\", \"1h\", \"15m\"]);\r\n\r\n    if (runLtf) {\r\n      const minBars = clamp(Number(body.ltfPlan?.minBars ?? 120), 60, 1000);\r\n      const missing = ([\"4h\", \"1h\", \"15m\"] as Timeframe[]).filter((tf) => (tfCounts[tf] ?? 0) < minBars);\r\n      if (missing.length) {\r\n        const reasons = [`ltf_data_missing_or_insufficient:${missing.join(\",\")}`, `minBars=${minBars}`];\r\n        const snapshot = {\n          symbol,\n          price: 0,\n          equity: Number.isFinite(Number(body.equityUsd)) ? Number(body.equityUsd) : 100,\n          constraints: {\n            maxLeverage: clamp(Number(body.constraints?.maxLeverage ?? 10), 1, 10),\n            maxRiskPct: clamp(Number(body.constraints?.maxRiskPct ?? 1), 0.1, 5),\n            minRR: clamp(Number(body.constraints?.minRR ?? 1.8), 1, 5),\n          },\n          counts: tfCounts,\n          gate: { blocked: true, reasons, higherTimeframesUsed: [], strongHigherTrend: false },\n          setup: ({ ok: false, setupType: \"NONE\", structure: \"MIXED\", confidence: 0, bias: \"NONE\", entryZone: { lo: 0, hi: 0, kind: \"market\" }, stop: { price: 0, rationale: \"ltf_data\" }, targets: [] as SetupSignal[\"targets\"], reasons } satisfies SetupSignal),\n          data_health: {\n            generatedAt: new Date().toISOString(),\n            timeframes: [],\n            missingOrStale: [\"4h\", \"1h\", \"15m\"],\n            blocked: true,\n          } as DataHealth,\n          news: [],\n          timeframes: [],\n          orderBlocks: [],\n          live: { ws: null },\n        };\n\r\n        const plan: ModelPlan = {\r\n          action: \"NO_TRADE\",\r\n          leverage: 1,\r\n          entry: { type: \"market\" },\r\n          stop: { price: 0, rationale: \"ltf_data_missing\" },\r\n          targets: [{ price: 0, sizePct: 100 }],\r\n          riskPct: 0,\r\n          notes: reasons.join(\"; \"),\r\n          citations: [],\r\n        };\r\n\r\n        return NextResponse.json({ ok: true, snapshot, gate: snapshot.gate, setup: snapshot.setup, rules: [], plan, verdict: { ok: true, reasons, rr: null } }, { status: 200 });\r\n      }\r\n    }\r\n\r\n    // ensure snapshot always includes the HTF set + setup tfs (so UI and gating are consistent)\r\n    const useDaily = (tfCounts[\"1d\"] ?? 0) >= 120;\r\n    const htfs: Timeframe[] = useDaily ? [\"1d\", \"4h\"] : [\"12h\", \"4h\"];\r\n    const setupTfs: Timeframe[] = [\"15m\", \"1h\", \"4h\"];\r\n    const timeframes = sortTimeframes(uniq<Timeframe>([...requestedTfs, ...htfs, ...setupTfs]));\n\r\n    // 1) Candles -> summaries\n    const tfData: TFSummary[] = [];\n    let price = 0;\n    const tfRows = new Map<Timeframe, CandleRow[]>();\n\n    for (const tf of timeframes) {\n      const rows = await fetchCandles(sb, symbol, tf, lookbackSummary);\n      tfRows.set(tf, rows);\n      const s = summarize(tf, rows);\n      tfData.push(s);\n    }\n\n    const nowMs = Date.now();\n    const dataHealth: DataHealth = {\n      generatedAt: new Date(nowMs).toISOString(),\n      timeframes: timeframes.map((tf) => computeTfHealth(tf, tfRows.get(tf) ?? [], nowMs)),\n      missingOrStale: [],\n      blocked: false,\n    };\n    dataHealth.missingOrStale = dataHealth.timeframes\n      .filter((h) => h.n === 0 || h.missingBars > 0 || h.stale)\n      .map((h) => h.tf);\n    dataHealth.blocked = dataHealth.missingOrStale.length > 0;\n\r\n    // prefer price from 15m then 1h then first ok\r\n    const p15 = getTfSummary(tfData, \"15m\")?.price;\r\n    const p1h = getTfSummary(tfData, \"1h\")?.price;\r\n    const pAny = (tfData.find((x) => x.ok) as Extract<TFSummary, { ok: true }> | undefined)?.price;\r\n    price = Number(p15 ?? p1h ?? pAny ?? 0);\r\n\r\n    if (!Number.isFinite(price) || price <= 0) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"No usable candle data (price not resolved).\", symbol, timeframes, tfData },\r\n        { status: 422 }\r\n      );\r\n    }\r\n\r\n    // 2) Live WS probe\n    const ws = await binanceProbe(\n      symbol,\n      clamp(body.wsProbe?.durationMs ?? 2000, 250, 8000),\n      clamp(body.wsProbe?.maxMessages ?? 800, 50, 3000)\n    );\n\n    const news = await fetchNews(sb, symbol, 6);\n\r\n    // 3) Regime gate (adaptive HTF)\r\n    const gate = buildRegimeGate(tfData, tfCounts);\n    const allowChop = gate.reasons.some((r) => r.startsWith(\"htf_chop_high\"));\n\r\n    // 4) Setup detector (candle-only)  strict pre-gate to prevent chop bleed\r\n    const tf15mRows = await fetchCandles(sb, symbol, \"15m\", lookbackSetup);\r\n    const tf1hRows = await fetchCandles(sb, symbol, \"1h\", lookbackSetup);\r\n    const tf4hRows = await fetchCandles(sb, symbol, \"4h\", lookbackSetup);\r\n\r\n    const setup = detectSetup({ tf15m: tf15mRows, tf1h: tf1hRows, tf4h: tf4hRows, price });\n    // Order Blocks (deterministic, from candles table). Note: fetchCandles() returns DESC; detectOrderBlocks() handles ordering.\r\n    const orderBlocksAll: OrderBlock[] = [\n      ...detectOrderBlocks([...tf15mRows].reverse(), \"15m\"),\n      ...detectOrderBlocks([...tf1hRows].reverse(), \"1h\"),\n      ...detectOrderBlocks([...tf4hRows].reverse(), \"4h\"),\n    ];\n\r\n    const obMap = new Map<string, OrderBlock>();\r\n    for (const ob of orderBlocksAll) {\r\n      const k = `${ob.tf}|${ob.side}|${ob.createdTs}|${ob.zoneLo.toFixed(2)}|${ob.zoneHi.toFixed(2)}`;\r\n      const prev = obMap.get(k);\r\n      if (!prev || ob.score > prev.score) obMap.set(k, ob);\r\n    }\r\n    const orderBlocks = Array.from(obMap.values()).sort((a, b) => b.score - a.score);\r\n\r\n\r\n    // snapshot (always return this)\r\n    const snapshot = {\n      symbol,\n      price,\n      price_candle: price,\n      price_live: Number.isFinite(ws.lastPrice as number) ? ws.lastPrice : null,\n      price_live_ts: Number.isFinite(ws.lastTs as number) ? ws.lastTs : null,\n      equity,\n      constraints,\n      counts: tfCounts,\n      gate,\n      setup,\n      data_health: dataHealth,\n      chop_mode: allowChop,\n      chop_context: {\n        range15m: tf15mRows.length\n          ? {\n              hi: Math.max(...tf15mRows.slice(-48).map((r) => r.high)),\n              lo: Math.min(...tf15mRows.slice(-48).map((r) => r.low)),\n            }\n          : null,\n      },\n      news,\n      timeframes: tfData,\n      orderBlocks,\n      live: { ws },\n    };\n\n    // Gate 0: data completeness\n    if (dataHealth.blocked && !aggressive) {\n      const reasons = dataHealth.missingOrStale.map((tf) => `data_gap:${tf}`);\n      const plan: ModelPlan = {\n        action: \"NO_TRADE\",\n        leverage: 1,\n        entry: { type: \"market\" },\n        stop: { price, rationale: \"data_gap\" },\n        targets: [{ price, sizePct: 100 }],\n        riskPct: 0,\n        notes: reasons.join(\"; \"),\n        citations: [],\n      };\n      return NextResponse.json(\n        { ok: true, snapshot, gate, setup, rules: [], plan, verdict: { ok: true, reasons, rr: null } },\n        { status: 200 }\n      );\n    }\n\r\n    // Gate 1: HTF regime\r\n    if (gate.blocked && !bypassHtfGate) {\n      if (allowChop) {\n        const chopPlan = buildChopPlan(tf15mRows, price, constraints);\n        if (chopPlan.action !== \"NO_TRADE\") {\n          const chopVerdict = validate(chopPlan, constraints, price);\n          const decisionId = persist ? randomUUID() : null;\n          if (persist && decisionId) {\n            await persistDecision(sb, {\n              id: decisionId,\n              symbol,\n              mode,\n              timeframes,\n              lookback: lookbackSummary,\n              price,\n              price_live: snapshot.price_live ?? null,\n              gate,\n              setup,\n              plan: chopPlan,\n              verdict: chopVerdict,\n              intraday: null,\n              data_health: dataHealth,\n              news,\n            });\n          }\n          return NextResponse.json(\n            { ok: true, decision_id: decisionId, snapshot, gate, setup, rules: [], plan: chopPlan, verdict: chopVerdict },\n            { status: 200 }\n          );\n        }\n      }\n      const plan: ModelPlan = {\n        action: \"NO_TRADE\",\n        leverage: 1,\n        entry: { type: \"market\" },\n        stop: { price, rationale: \"regime_gate\" },\n        targets: [{ price, sizePct: 100 }],\n        riskPct: 0,\n        notes: gate.reasons.join(\"; \"),\n        citations: [],\n      };\n\n      return NextResponse.json(\n        { ok: true, snapshot, gate, setup, rules: [], plan, verdict: { ok: true, reasons: gate.reasons, rr: null } },\n        { status: 200 }\n      );\n    }\n\r\n\r\n    // Gate 2: deterministic setup (tight by design)\r\n    const minSetupConfidence = aggressive ? 40 : 55;\r\n    if (!aggressive && (!setup.ok || setup.confidence < minSetupConfidence) && !allowChop) {\n      const reasons = [\n        ...(setup.ok ? [] : [\"no_deterministic_setup\"]),\n        ...(setup.confidence < minSetupConfidence ? [`setup_confidence_below_${minSetupConfidence}`] : []),\n        ...setup.reasons,\n      ];\n\r\n      const plan: ModelPlan = {\r\n        action: \"NO_TRADE\",\r\n        leverage: 1,\r\n        entry: { type: \"market\" },\r\n        stop: { price, rationale: \"setup_gate\" },\r\n        targets: [{ price, sizePct: 100 }],\r\n        riskPct: 0,\r\n        notes: reasons.join(\"; \"),\r\n        citations: [],\r\n      };\r\n\r\n      return NextResponse.json({ ok: true, snapshot, gate, setup, rules: [], plan, verdict: { ok: true, reasons, rr: null } }, { status: 200 });\n    }\n\r\n    // 5) RAG query (include setup + gate in query so retrieval is relevant)\r\n    const ai = openaiClient();\n    const newsSummary = news\n      .slice(0, 4)\n      .map((n) => `${n.title}${n.source ? ` (${n.source})` : \"\"}`)\n      .join(\" | \");\n    const retrievalQuery =\n      `Rules for ${symbol}. Mode=${mode}${runLtf ? ` LTF=${ltfTimeframes.join(\"+\")}` : \"\"}. ` +\n      `HTF=${gate.higherTimeframesUsed.join(\"+\")} strong=${gate.strongHigherTrend}. ` +\n      `Setup=${setup.bias}/${setup.setupType} conf=${setup.confidence}. ` +\n      `TF Regime2=` +\n      `${(tfData as any[])\n        .map((x: any) =>\n          x.ok\n            ? `${x.tf}:${x.regime2.label} t=${x.regime2.trendScore.toFixed(0)} c=${x.regime2.chopScore.toFixed(0)}`\n            : `${x.tf}:na`\n        )\n        .join(\" | \")}. ` +\n      `${newsSummary ? `News=${newsSummary}. ` : \"\"}` +\n      `LiveTape msgs=${ws.messages} ia_p95=${ws.interArrival.p95.toFixed(1)}ms flow_imb=${ws.flow.imbalance.toFixed(3)}. ` +\n      `Need entry, stop, targets, invalidation, risk, leverage, explicit no-trade conditions. ` +\n      `HTF_GATE=${gate.blocked ? \"BLOCKED\" : \"OK\"} bypass=${bypassHtfGate}. `;\n\r\n    const rules = await retrieveRules(ai, sb, retrievalQuery);\r\n\r\n    if (!rules.length) {\r\n      const plan: ModelPlan = {\r\n        action: \"NO_TRADE\",\r\n        leverage: 1,\r\n        entry: { type: \"market\" },\r\n        stop: { price, rationale: \"no_rules\" },\r\n        targets: [{ price, sizePct: 100 }],\r\n        riskPct: 0,\r\n        notes: \"No rules retrieved from RAG.\",\r\n        citations: [],\r\n      };\r\n\r\n      return NextResponse.json(\r\n        {\r\n          ok: true,\r\n          snapshot,\r\n          gate,\r\n          setup,\r\n          rules: [],\r\n          plan,\r\n          verdict: { ok: false, reasons: [\"no_rules_retrieved\"], rr: null },\r\n        },\r\n        { status: 200 }\r\n      );\r\n    }\r\n\r\n    // 6) Model plan + engine validate\r\n    // Pass snapshot (includes setup + gate) + full rule chunks to model\r\n    let plan = await callModel(ai, snapshot, rules, constraints, { mode, ltfTimeframes: ltfTimeframes, openai: body.openai });\n    let verdict = validate(plan, constraints, price);\n    if (allowChop && plan.action === \"NO_TRADE\") {\n      const chopPlan = buildChopPlan(tf15mRows, price, constraints);\n      if (chopPlan.action !== \"NO_TRADE\") {\n        plan = chopPlan;\n        verdict = validate(plan, constraints, price);\n      }\n    }\n    const intradayVerdict = validateIntraday((plan as any).intraday, constraints, price);\n\n    const decisionId = persist ? randomUUID() : null;\n    if (persist && decisionId) {\n      await persistDecision(sb, {\n        id: decisionId,\n        symbol,\n        mode,\n        timeframes,\n        lookback: lookbackSummary,\n        price,\n        price_live: snapshot.price_live ?? null,\n        gate,\n        setup,\n        plan,\n        verdict,\n        intraday: (plan as any).intraday ?? null,\n        data_health: dataHealth,\n        news,\n      });\n    }\n\n    return NextResponse.json(\n      {\n        ok: true,\n        decision_id: decisionId,\n        snapshot,\n        gate,\n        setup,\n        rules: rules.map((r: any) => ({\r\n          id: r.id,\r\n          doc_name: r.doc_name,\r\n          page: r.page,\r\n          section: r.section,\r\n          chunk_type: r.chunk_type,\r\n          similarity: r.similarity,\r\n        })),\r\n        plan,\r\n        execution: computeExecutionSizing(plan, price, equity),\r\n        intraday: (plan as any).intraday ?? null,\r\n        verdict,\r\n        intradayVerdict,\r\n      },\r\n      { status: 200 }\r\n    );\r\n  } catch (e) {\r\n    return NextResponse.json({ ok: false, error: (e as Error)?.message ?? \"Unknown error\" }, { status: 500 });\r\n  }\r\n}\n"],"names":[],"mappings":"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"}}]
}