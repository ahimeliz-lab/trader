{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/trader/app/api/risk-check/route.ts"],"sourcesContent":["import \"server-only\";\nimport { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\ntype RiskCheckRequest = {\n  accountId: string;\n  symbol?: string;\n  livePrice?: number;\n};\n\nfunction env(name: string): string {\n  const v = process.env[name];\n  if (!v) throw new Error(`Missing env var: ${name}`);\n  return v;\n}\n\nfunction sbAdmin() {\n  return createClient(env(\"SUPABASE_URL\"), env(\"SUPABASE_SERVICE_ROLE_KEY\"), {\n    auth: { persistSession: false },\n  });\n}\n\nfunction toPerp(sym: string) {\n  const s = sym.trim().toUpperCase();\n  return s.endsWith(\"-PERP\") ? s : `${s}-PERP`;\n}\n\nexport async function POST(req: Request) {\n  const sb = sbAdmin();\n  try {\n    const body = (await req.json()) as RiskCheckRequest;\n    if (!body.accountId) return NextResponse.json({ ok: false, error: \"accountId required\" }, { status: 400 });\n\n    const symbolFilter = body.symbol ? toPerp(body.symbol) : null;\n    const live = Number(body.livePrice ?? NaN);\n\n    const { data: positions, error: posErr } = await sb\n      .from(\"trade_positions\")\n      .select(\"symbol,qty,avg_entry_price,realized_pnl_usd\")\n      .eq(\"account_id\", body.accountId);\n    if (posErr) throw new Error(`positions query failed: ${posErr.message}`);\n\n    const { data: acct } = await sb\n      .from(\"trade_accounts\")\n      .select(\"cash_balance\")\n      .eq(\"id\", body.accountId)\n      .maybeSingle();\n    const cash = Number(acct?.cash_balance ?? 0);\n\n    const triggers: any[] = [];\n\n    for (const p of positions ?? []) {\n      const symbol = String(p.symbol ?? \"\");\n      if (symbolFilter && symbol !== symbolFilter) continue;\n      const qty = Number(p.qty ?? 0);\n      if (!Number.isFinite(qty) || qty === 0) continue;\n\n      let markPrice = live;\n      if (!Number.isFinite(markPrice) || markPrice <= 0) {\n        const { data: lastCandle } = await sb\n          .from(\"candles\")\n          .select(\"close\")\n          .eq(\"symbol\", symbol)\n          .eq(\"timeframe\", \"15m\")\n          .order(\"open_time\", { ascending: false })\n          .limit(1)\n          .maybeSingle();\n        markPrice = Number(lastCandle?.close ?? NaN);\n      }\n      if (!Number.isFinite(markPrice) || markPrice <= 0) continue;\n\n      const { data: risk } = await sb\n        .from(\"position_risk\")\n        .select(\"stop_price,max_loss_pct\")\n        .eq(\"account_id\", body.accountId)\n        .eq(\"symbol\", symbol)\n        .maybeSingle();\n\n      const stop = Number(risk?.stop_price ?? NaN);\n      const maxLossPct = Number(risk?.max_loss_pct ?? NaN);\n\n      let hitStop = false;\n      if (Number.isFinite(stop) && stop > 0) {\n        hitStop = qty > 0 ? markPrice <= stop : markPrice >= stop;\n      }\n\n      let hitMaxLoss = false;\n      if (Number.isFinite(maxLossPct) && maxLossPct > 0 && cash > 0) {\n        const avg = Number(p.avg_entry_price ?? 0);\n        const unreal = Number.isFinite(avg) ? (markPrice - avg) * qty : 0;\n        const loss = Math.max(0, -unreal);\n        if ((loss / cash) * 100 >= maxLossPct) hitMaxLoss = true;\n      }\n\n      if (hitStop || hitMaxLoss) {\n        triggers.push({ symbol, reason: hitStop ? \"stop_loss_hit\" : \"max_loss_hit\", markPrice });\n        // Close immediately\n        const side = qty > 0 ? \"sell\" : \"buy\";\n        const closeQty = Math.abs(qty);\n        const clientOrderId = `risk_${Date.now()}`;\n        const { data: order, error: orderErr } = await sb\n          .from(\"trade_orders\")\n          .insert({\n            account_id: body.accountId,\n            client_order_id: clientOrderId,\n            symbol,\n            side,\n            type: \"market\",\n            qty: closeQty,\n            leverage: 1,\n            status: \"new\",\n            note: hitStop ? \"stop_loss_hit\" : \"max_loss_hit\",\n          })\n          .select(\"*\")\n          .single();\n        if (orderErr) throw new Error(`order insert failed: ${orderErr.message}`);\n\n        const { error: fillErr } = await sb.from(\"trade_fills\").insert({\n          order_id: order.id,\n          account_id: body.accountId,\n          symbol,\n          side,\n          qty: closeQty,\n          price: markPrice,\n          fee_usd: 0,\n        });\n        if (fillErr) throw new Error(`fill insert failed: ${fillErr.message}`);\n\n        const { error: applyErr } = await sb.rpc(\"apply_fill_to_position_and_cash\", {\n          p_account_id: body.accountId,\n          p_symbol: symbol,\n          p_side: side,\n          p_qty: closeQty,\n          p_price: markPrice,\n          p_fee_usd: 0,\n        });\n        if (applyErr) throw new Error(`apply_fill_to_position_and_cash failed: ${applyErr.message}`);\n\n        await sb.from(\"trade_orders\").update({ status: \"filled\" }).eq(\"id\", order.id);\n\n        // Trade journal close (best effort)\n        try {\n          const { data: j } = await sb\n            .from(\"trade_journal\")\n            .select(\"id,entry_price,qty,side\")\n            .eq(\"account_id\", body.accountId)\n            .eq(\"symbol\", symbol)\n            .eq(\"status\", \"open\")\n            .order(\"entry_time\", { ascending: false })\n            .limit(1)\n            .maybeSingle();\n          if (j?.id) {\n            const entryPrice = Number(j.entry_price ?? 0);\n            const qtyJ = Number(j.qty ?? closeQty);\n            const dir = (j.side ?? \"buy\") === \"buy\" ? 1 : -1;\n            const pnl = Number.isFinite(entryPrice) ? (markPrice - entryPrice) * qtyJ * dir : null;\n            await sb\n              .from(\"trade_journal\")\n              .update({\n                exit_price: markPrice,\n                exit_time: new Date().toISOString(),\n                pnl_usd: pnl,\n                status: \"closed\",\n                exit_reason: hitStop ? \"stop_loss_hit\" : \"max_loss_hit\",\n              })\n              .eq(\"id\", j.id);\n          }\n        } catch {\n          // ignore\n        }\n      }\n    }\n\n    return NextResponse.json({ ok: true, triggers }, { status: 200 });\n  } catch (e) {\n    return NextResponse.json({ ok: false, error: (e as Error).message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}