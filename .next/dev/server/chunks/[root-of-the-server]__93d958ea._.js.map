{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/trader/app/api/decision-evals/route.ts"],"sourcesContent":["import \"server-only\";\nimport { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nfunction env(name: string): string {\n  const v = process.env[name];\n  if (!v) throw new Error(`Missing env var: ${name}`);\n  return v;\n}\n\nfunction sbAdmin() {\n  return createClient(env(\"SUPABASE_URL\"), env(\"SUPABASE_SERVICE_ROLE_KEY\"), {\n    auth: { persistSession: false },\n  });\n}\n\nexport async function GET(req: Request) {\n  try {\n    const url = new URL(req.url);\n    const limit = Math.min(500, Math.max(1, Number(url.searchParams.get(\"limit\") ?? 200)));\n    const symbol = (url.searchParams.get(\"symbol\") ?? \"\").trim().toUpperCase();\n\n    const sb = sbAdmin();\n    let data: any[] | null = null;\n    let symbolFiltered = false;\n\n    // Try joined view (requires FK from decision_evals.decision_id -> decision_logs.id)\n    if (symbol) {\n      const joined = await sb\n        .from(\"decision_evals\")\n        .select(\"decision_id,outcome,rr,decision_logs!inner(symbol,created_at)\")\n        .eq(\"decision_logs.symbol\", symbol)\n        .order(\"decision_logs.created_at\", { ascending: false })\n        .limit(limit);\n      if (!joined.error) {\n        data = joined.data ?? [];\n        symbolFiltered = true;\n      }\n    }\n\n    // Fallback: no join available\n    if (!data) {\n      const plain = await sb\n        .from(\"decision_evals\")\n        .select(\"decision_id,outcome,rr,evaluated_at\")\n        .order(\"evaluated_at\", { ascending: false })\n        .limit(limit);\n      if (plain.error) throw new Error(plain.error.message);\n      data = plain.data ?? [];\n    }\n\n    const outcomes = { T1: 0, STOP: 0, OPEN: 0, INVALID: 0, NO_TRADE: 0 };\n    for (const row of data ?? []) {\n      const o = String((row as any).outcome ?? \"\").toUpperCase();\n      if (o in outcomes) outcomes[o as keyof typeof outcomes] += 1;\n      else outcomes.INVALID += 1;\n    }\n\n    return NextResponse.json({ ok: true, outcomes, rows: data ?? [], symbolFiltered }, { status: 200 });\n  } catch (e) {\n    return NextResponse.json({ ok: false, error: (e as Error).message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;;;;AAEO,MAAM,UAAU;AAChB,MAAM,UAAU;AAChB,MAAM,aAAa;AAE1B,SAAS,IAAI,IAAY;IACvB,MAAM,IAAI,QAAQ,GAAG,CAAC,KAAK;IAC3B,IAAI,CAAC,GAAG,MAAM,IAAI,MAAM,CAAC,iBAAiB,EAAE,MAAM;IAClD,OAAO;AACT;AAEA,SAAS;IACP,OAAO,IAAA,gMAAY,EAAC,IAAI,iBAAiB,IAAI,8BAA8B;QACzE,MAAM;YAAE,gBAAgB;QAAM;IAChC;AACF;AAEO,eAAe,IAAI,GAAY;IACpC,IAAI;QACF,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;QAC3B,MAAM,QAAQ,KAAK,GAAG,CAAC,KAAK,KAAK,GAAG,CAAC,GAAG,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC,YAAY;QAChF,MAAM,SAAS,CAAC,IAAI,YAAY,CAAC,GAAG,CAAC,aAAa,EAAE,EAAE,IAAI,GAAG,WAAW;QAExE,MAAM,KAAK;QACX,IAAI,OAAqB;QACzB,IAAI,iBAAiB;QAErB,oFAAoF;QACpF,IAAI,QAAQ;YACV,MAAM,SAAS,MAAM,GAClB,IAAI,CAAC,kBACL,MAAM,CAAC,iEACP,EAAE,CAAC,wBAAwB,QAC3B,KAAK,CAAC,4BAA4B;gBAAE,WAAW;YAAM,GACrD,KAAK,CAAC;YACT,IAAI,CAAC,OAAO,KAAK,EAAE;gBACjB,OAAO,OAAO,IAAI,IAAI,EAAE;gBACxB,iBAAiB;YACnB;QACF;QAEA,8BAA8B;QAC9B,IAAI,CAAC,MAAM;YACT,MAAM,QAAQ,MAAM,GACjB,IAAI,CAAC,kBACL,MAAM,CAAC,uCACP,KAAK,CAAC,gBAAgB;gBAAE,WAAW;YAAM,GACzC,KAAK,CAAC;YACT,IAAI,MAAM,KAAK,EAAE,MAAM,IAAI,MAAM,MAAM,KAAK,CAAC,OAAO;YACpD,OAAO,MAAM,IAAI,IAAI,EAAE;QACzB;QAEA,MAAM,WAAW;YAAE,IAAI;YAAG,MAAM;YAAG,MAAM;YAAG,SAAS;YAAG,UAAU;QAAE;QACpE,KAAK,MAAM,OAAO,QAAQ,EAAE,CAAE;YAC5B,MAAM,IAAI,OAAO,AAAC,IAAY,OAAO,IAAI,IAAI,WAAW;YACxD,IAAI,KAAK,UAAU,QAAQ,CAAC,EAA2B,IAAI;iBACtD,SAAS,OAAO,IAAI;QAC3B;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM;YAAU,MAAM,QAAQ,EAAE;YAAE;QAAe,GAAG;YAAE,QAAQ;QAAI;IACnG,EAAE,OAAO,GAAG;QACV,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO,AAAC,EAAY,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACrF;AACF"}}]
}