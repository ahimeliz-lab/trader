{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/trader/app/api/chat/route.ts"],"sourcesContent":["import \"server-only\";\r\nimport { NextResponse } from \"next/server\";\r\nimport OpenAI from \"openai\";\nimport { createClient } from \"@supabase/supabase-js\";\n\r\n/**\r\n * /api/chat\r\n * - Wrapper around /api/analyze that turns the analyzer snapshot into a concise, user-facing answer.\r\n * - Hardened for \"no candle data\" / partial timeframe coverage.\r\n *\r\n * NOTE: This route does NOT place real orders. It returns paper trading plans only.\r\n */\r\n\r\nexport const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\nexport const revalidate = 0;\r\n\r\ntype Timeframe = \"5m\" | \"15m\" | \"1h\" | \"4h\" | \"12h\" | \"1d\" | \"3d\";\r\ntype Mode = \"HTF\" | \"LTF\" | \"FULL\" | \"LTF_ONLY\";\r\n\r\ntype ChatBody = {\n  message: string;\n  question?: string;\n  accountId?: string;\n\n  symbol: string;\n  mode?: Mode; // preferred (aligns with /api/analyze)\r\n  tradeMode?: \"HTF\" | \"LTF_ONLY\"; // legacy UI field; mapped to mode\r\n\r\n  timeframes?: Timeframe[];\r\n  lookback?: number;\r\n  equityUsd?: number;\r\n\r\n  aggressive?: boolean;\r\n\r\n  constraints?: { maxLeverage?: number; maxRiskPct?: number; minRR?: number };\r\n\r\n  ltfPlan?: { enabled?: boolean; timeframes?: Array<\"4h\" | \"1h\" | \"15m\">; minBars?: number };\r\n\r\n  /** optional: pass through */\n  openai?: { model?: string; temperature?: number; maxTokens?: number };\n};\n\nfunction sbAdmin() {\n  const url = requireEnv(\"SUPABASE_URL\");\n  const key = requireEnv(\"SUPABASE_SERVICE_ROLE_KEY\");\n  return createClient(url, key, { auth: { persistSession: false } });\n}\n\r\nfunction requireEnv(name: string): string {\r\n  const v = process.env[name];\r\n  if (!v) throw new Error(`Missing env var: ${name}`);\r\n  return v;\r\n}\r\n\r\nfunction openaiClient() {\r\n  return new OpenAI({ apiKey: requireEnv(\"OPENAI_API_KEY\") });\r\n}\r\n\r\nfunction clamp(n: number, lo: number, hi: number) {\r\n  if (!Number.isFinite(n)) return lo;\r\n  return Math.min(hi, Math.max(lo, n));\r\n}\r\n\r\nfunction asUpperSymbol(s: string) {\r\n  return (s || \"\").trim().toUpperCase();\r\n}\r\n\r\nfunction mapMode(body: ChatBody): Mode {\r\n  // Prefer explicit analyzer mode\r\n  if (body.mode) return body.mode;\r\n  // Legacy: UI used tradeMode\r\n  if (body.tradeMode === \"LTF_ONLY\") return \"LTF_ONLY\";\r\n  if (body.tradeMode === \"HTF\") return \"HTF\";\r\n  // If ltfPlan.enabled exists, default to LTF (same as /api/analyze)\r\n  if (body.ltfPlan?.enabled) return \"LTF\";\r\n  return \"HTF\";\r\n}\r\n\r\nfunction looksLikeDataMissing(text: string) {\n  const t = (text || \"\").toLowerCase();\n  return (\n    t.includes(\"missing\") ||\n    t.includes(\"no candle\") ||\n    t.includes(\"no recent price\") ||\n    t.includes(\"price not resolved\") ||\n    t.includes(\"ltf_data_missing\") ||\n    t.includes(\"insufficient\")\n  );\n}\n\nfunction looksLikePositionQuestion(text: string) {\n  const t = (text || \"\").toLowerCase();\n  return (\n    t.includes(\"position\") ||\n    t.includes(\"pnl\") ||\n    t.includes(\"profit\") ||\n    t.includes(\"loss\") ||\n    t.includes(\"status\") ||\n    t.includes(\"open\") ||\n    t.includes(\"unrealized\")\n  );\n}\n\nfunction fmtUsd(n: number | null | undefined) {\n  if (n === null || n === undefined || !Number.isFinite(Number(n))) return \"n/a\";\n  const v = Number(n);\n  const sign = v < 0 ? \"-\" : \"\";\n  return `${sign}$${Math.abs(v).toFixed(2)}`;\n}\n\nfunction fmtNum(n: number | null | undefined, digits = 4) {\n  if (n === null || n === undefined || !Number.isFinite(Number(n))) return \"n/a\";\n  return Number(n).toFixed(digits);\n}\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = (await req.json()) as Partial<ChatBody>;\r\n    const message = (body.message ?? body.question ?? \"\").trim();\n    const symbol = asUpperSymbol(body.symbol || \"\");\r\n    if (!message) return NextResponse.json({ ok: false, error: \"message is required\" }, { status: 400 });\r\n    if (!symbol) return NextResponse.json({ ok: false, error: \"symbol is required\" }, { status: 400 });\r\n\r\n    const mode = mapMode(body as ChatBody);\r\n\r\n    // Always enforce 10x cap here as well.\r\n    const constraints = {\r\n      maxLeverage: clamp(Number(body.constraints?.maxLeverage ?? 10), 1, 10),\r\n      maxRiskPct: clamp(Number(body.constraints?.maxRiskPct ?? 1.0), 0.1, 5),\r\n      minRR: clamp(Number(body.constraints?.minRR ?? 1.8), 1, 5),\r\n    };\r\n\r\n    // --- Call /api/analyze (single source of truth) ---\r\n    const analyzeUrl = new URL(\"/api/analyze\", req.url);\r\n    const analyzePayload = {\r\n      symbol,\r\n      mode,\r\n      timeframes: body.timeframes,\r\n      lookback: body.lookback,\r\n      equityUsd: body.equityUsd ?? 100,\r\n      aggressive: Boolean(body.aggressive),\r\n      constraints,\r\n      ltfPlan: body.ltfPlan,\r\n      // keep probe minimal (analyze clamps to >=250ms anyway)\r\n      wsProbe: { durationMs: 250, maxMessages: 500 },\r\n      openai: body.openai,\r\n    };\r\n\r\n    const ar = await fetch(analyzeUrl.toString(), {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify(analyzePayload),\r\n    });\r\n\r\n    const analyzeJson = await ar.json().catch(() => null);\r\n\r\n    // If analyzer hard-failed (e.g. price not resolved), return deterministic troubleshooting.\r\n    if (!ar.ok || !analyzeJson?.ok) {\r\n      const errText =\r\n        analyzeJson?.error ||\r\n        analyzeJson?.message ||\r\n        (typeof analyzeJson === \"string\" ? analyzeJson : \"Analyzer error\");\r\n\r\n      return NextResponse.json(\r\n        {\r\n          ok: true,\r\n          symbol,\r\n          mode,\r\n          answer_markdown:\n            `**Data issue -- can't assess market conditions.**\\n\\n` +\n            `Reason: \\`${errText}\\`\\n\\n` +\r\n            `**What to fix**\\n` +\r\n            `- Confirm your ingest process is writing rows into \\`public.candles\\` for \\`${symbol}\\`.\\n` +\r\n            `- Check you have recent candles for 15m/1h/4h (and 12h/1d if using HTF).\\n` +\r\n            `- Verify the app is using the same \\`SUPABASE_URL\\` project as your ingest.\\n`,\r\n          data_health: {\r\n            http_status: ar.status,\r\n            analyzer_error: errText,\r\n          },\r\n          raw: analyzeJson,\r\n        },\r\n        { status: 200 }\r\n      );\r\n    }\r\n\r\n    const snapshot = analyzeJson.snapshot ?? null;\n    const plan = analyzeJson.plan ?? null;\n    const execution = analyzeJson.execution ?? null;\n\n    const accountId = (body.accountId || \"\").trim();\n    let account: any = null;\n    let positions: any[] = [];\n    let equityPoint: any = null;\n    let markPrice = Number(snapshot?.price_live ?? snapshot?.price ?? 0);\n    if (!Number.isFinite(markPrice) || markPrice <= 0) markPrice = 0;\n\n    if (accountId) {\n      try {\n        const sb = sbAdmin();\n        const { data: acct } = await sb\n          .from(\"trade_accounts\")\n          .select(\"id,cash_balance\")\n          .eq(\"id\", accountId)\n          .maybeSingle();\n        account = acct ?? null;\n\n        const { data: pos } = await sb\n          .from(\"trade_positions\")\n          .select(\"symbol,qty,avg_entry_price,realized_pnl_usd,updated_at\")\n          .eq(\"account_id\", accountId);\n        positions = Array.isArray(pos) ? pos : [];\n\n        const { data: eq } = await sb\n          .from(\"trade_equity_points\")\n          .select(\"created_at,equity_usd,cash_usd,note\")\n          .eq(\"account_id\", accountId)\n          .order(\"created_at\", { ascending: false })\n          .limit(1);\n        equityPoint = Array.isArray(eq) && eq.length ? eq[0] : null;\n      } catch {\n        // ignore account lookup errors\n      }\n    }\n\n    const isPositionQuestion = looksLikePositionQuestion(message);\n    if (isPositionQuestion) {\n      if (!accountId) {\n        return NextResponse.json(\n          {\n            ok: true,\n            symbol,\n            mode,\n            answer_markdown:\n              `**Position status unavailable.**\\n\\n` +\n              `Reason: \\`accountId\\` is missing. Please set a paper account id and retry.`,\n            key_points: [],\n            data_gaps: [\"missing accountId\"],\n            followups: [\"Provide an accountId to fetch positions and equity.\"],\n            wants_trade: false,\n            snapshot,\n            plan,\n            execution,\n          },\n          { status: 200 }\n        );\n      }\n\n      const posLines = positions.length\n        ? positions.map((p) => {\n            const qty = Number(p.qty ?? 0);\n            const avg = Number(p.avg_entry_price ?? 0);\n            const unrealized =\n              markPrice > 0 && Number.isFinite(qty) && Number.isFinite(avg)\n                ? (markPrice - avg) * qty\n                : null;\n            return `- ${p.symbol}: qty=${fmtNum(qty, 6)} avg=${fmtNum(avg, 2)} uPnL=${fmtUsd(unrealized)} rPnL=${fmtUsd(p.realized_pnl_usd)}`;\n          })\n        : [\"- No open positions.\"];\n\n      const totalUnrealized = positions.reduce((acc, p) => {\n        const qty = Number(p.qty ?? 0);\n        const avg = Number(p.avg_entry_price ?? 0);\n        if (!Number.isFinite(qty) || !Number.isFinite(avg) || markPrice <= 0) return acc;\n        return acc + (markPrice - avg) * qty;\n      }, 0);\n\n      const totalRealized = positions.reduce((acc, p) => {\n        const v = Number(p.realized_pnl_usd ?? 0);\n        return Number.isFinite(v) ? acc + v : acc;\n      }, 0);\n\n      return NextResponse.json(\n        {\n          ok: true,\n          symbol,\n          mode,\n          answer_markdown:\n            `### Position Status for ${symbol}\\n` +\n            `- **Current Price:** ${markPrice > 0 ? fmtNum(markPrice, 2) : \"n/a\"}\\n` +\n            `- **Cash Balance:** ${fmtUsd(account?.cash_balance)}\\n` +\n            `- **Last Equity:** ${fmtUsd(equityPoint?.equity_usd)}\\n` +\n            `- **Total Unrealized PnL:** ${markPrice > 0 ? fmtUsd(totalUnrealized) : \"n/a\"}\\n` +\n            `- **Total Realized PnL:** ${fmtUsd(totalRealized)}\\n\\n` +\n            `### Open Positions\\n` +\n            posLines.join(\"\\n\"),\n          key_points: [],\n          data_gaps: markPrice > 0 ? [] : [\"live price missing\"],\n          followups: [],\n          wants_trade: false,\n          snapshot,\n          plan,\n          execution,\n          account,\n          positions,\n          equityPoint,\n        },\n        { status: 200 }\n      );\n    }\n\r\n    const counts = snapshot?.counts ?? {};\r\n    const tfKeys = [\"15m\", \"1h\", \"4h\", \"12h\", \"1d\"] as const;\r\n    const totalRows = tfKeys.reduce((acc, k) => acc + (Number(counts?.[k]) || 0), 0);\r\n\r\n    // If no rows, short-circuit: don't waste tokens.\r\n    if (totalRows <= 0) {\r\n      return NextResponse.json(\r\n        {\r\n          ok: true,\r\n          symbol,\r\n          mode,\r\n          answer_markdown:\r\n            `**No candle data found for ${symbol}.**\\n\\n` +\r\n            `Your analyzer snapshot returned 0 rows across monitored timeframes.\\n\\n` +\r\n            `**Next steps**\\n` +\r\n            `1) Verify your ingest script is running and connected to the same Supabase project.\\n` +\r\n            `2) In Supabase SQL editor run:\\n` +\r\n            `   \\`select timeframe, count(*) from public.candles where symbol='${symbol}' group by 1 order by 1;\\`\\n` +\r\n            `3) Ensure at least 200+ rows for 15m/1h/4h.\\n`,\r\n          data_health: { counts, totalRows },\r\n          snapshot,\r\n        },\r\n        { status: 200 }\r\n      );\r\n    }\r\n\r\n    // --- OpenAI synthesis ---\r\n    const ai = openaiClient();\r\n    const model = body.openai?.model || process.env.OPENAI_CHAT_MODEL || \"gpt-4o-mini\";\r\n\r\n    // Keep the model grounded: it MUST base answer on snapshot + plan.\r\n    const sys = [\n      \"You are a trading analyst inside an app.\",\n      \"You must answer using ONLY the provided analyzer snapshot/plan. Do not invent data.\",\n      \"If account/positions data is provided, use it to answer position status and PnL questions.\",\n      \"If data is missing for any timeframe, explicitly say which timeframes are missing and what that implies.\",\n      \"If the user asks for a trade, summarize the plan with entry/stop/targets and include execution sizing if present.\",\n      \"Always keep it concise and operational.\",\n    ].join(\" \");\n\r\n    const user = {\n      message,\n      mode,\n      snapshot: {\n        symbol: snapshot?.symbol,\n        price: snapshot?.price,\n        price_live: snapshot?.price_live,\n        price_live_ts: snapshot?.price_live_ts,\n        constraints: snapshot?.constraints,\n        counts: snapshot?.counts,\n        gate: snapshot?.gate,\n        setup: snapshot?.setup,\n        data_health: snapshot?.data_health,\n        news: snapshot?.news,\n        // tf summaries can be large; keep small\n        timeframes: Array.isArray(snapshot?.timeframes)\n          ? snapshot.timeframes.map((t: any) => ({\n              tf: t.tf,\r\n              ok: t.ok,\r\n              n: t.n,\r\n              price: t.price,\r\n              ema: t.ema,\r\n              rsi14: t.rsi14,\r\n              regime2: t.regime2,\r\n              volume: t.volume,\r\n            }))\r\n          : [],\r\n        orderBlocks: Array.isArray(snapshot?.orderBlocks)\r\n          ? snapshot.orderBlocks.slice(0, 8).map((ob: any) => ({\r\n              tf: ob.tf,\r\n              side: ob.side,\r\n              zoneLo: ob.zoneLo,\r\n              zoneHi: ob.zoneHi,\r\n              createdTs: ob.createdTs,\r\n              score: ob.score,\r\n              notes: ob.notes,\r\n            }))\r\n          : [],\r\n      },\n      plan,\n      execution,\n      verdict: analyzeJson.verdict,\n      intraday: analyzeJson.intraday,\n      intradayVerdict: analyzeJson.intradayVerdict,\n      account: accountId\n        ? {\n            accountId,\n            cash: account?.cash_balance ?? null,\n            equity: equityPoint?.equity_usd ?? null,\n            markPrice: markPrice || null,\n            positions: positions.map((p) => {\n              const qty = Number(p.qty ?? 0);\n              const avg = Number(p.avg_entry_price ?? 0);\n              const unrealized =\n                markPrice > 0 && Number.isFinite(qty) && Number.isFinite(avg)\n                  ? (markPrice - avg) * qty\n                  : null;\n              return {\n                symbol: p.symbol,\n                qty,\n                avg_entry_price: avg,\n                realized_pnl_usd: Number(p.realized_pnl_usd ?? 0),\n                unrealized_pnl_usd: unrealized,\n                updated_at: p.updated_at,\n              };\n            }),\n          }\n        : null,\n    };\n\r\n    const schema = {\r\n      name: \"ChatAnswer\",\r\n      schema: {\r\n        type: \"object\",\r\n        additionalProperties: false,\r\n        properties: {\r\n          answer_markdown: { type: \"string\" },\r\n          key_points: { type: \"array\", items: { type: \"string\" } },\r\n          data_gaps: { type: \"array\", items: { type: \"string\" } },\r\n          followups: { type: \"array\", items: { type: \"string\" } },\r\n          wants_trade: { type: \"boolean\" },\r\n        },\r\n        required: [\"answer_markdown\", \"key_points\", \"data_gaps\", \"followups\", \"wants_trade\"],\r\n      },\r\n    } as const;\r\n\r\n    let parsed: any = null;\r\n\r\n    try {\n      const resp: any = await ai.responses.create({\n        model,\n        temperature: clamp(Number(body.openai?.temperature ?? 0.2), 0, 0.8),\n        max_output_tokens: clamp(Number(body.openai?.maxTokens ?? 900), 200, 1600),\n        instructions: sys,\n        input: JSON.stringify(user),\n        text: {\n          format: {\n            type: \"json_schema\",\n            name: schema.name,\n            schema: schema.schema,\n            strict: true,\n          },\n        },\n      });\n\n      const content = String(resp.output_text ?? \"\");\n      parsed = JSON.parse(content);\n    } catch (e) {\n      // Fallback: return a deterministic answer built from the analyzer response.\r\n      const notes = String((plan?.notes ?? \"\") as string);\r\n      const missingHint = looksLikeDataMissing(notes) ? `\\n\\n**Data gaps**: ${notes}` : \"\";\r\n      const planLine =\r\n        plan?.action && plan.action !== \"NO_TRADE\"\r\n          ? `\\n\\n**Plan**: ${plan.action} (lev ${plan.leverage}x) entry=${plan.entry?.type ?? \"—\"} stop=${plan.stop?.price ?? \"—\"}`\r\n          : `\\n\\n**Plan**: NO_TRADE`;\r\n\r\n      return NextResponse.json(\r\n        {\n          ok: true,\n          symbol,\n          mode,\n          answer_markdown:\n            `**Analyzer snapshot**: price=${snapshot?.price ?? \"—\"}; gate=${snapshot?.gate?.blocked ? \"BLOCKED\" : \"OK\"}; setup=${snapshot?.setup?.bias ?? \"NONE\"}.\\n` +\n            planLine +\n            missingHint,\n          key_points: [],\n          data_gaps: [],\n          followups: [],\n          wants_trade: Boolean(plan?.action && plan.action !== \"NO_TRADE\"),\n          snapshot,\n          plan,\n          execution,\n          account,\n          positions,\n          equityPoint,\n        },\n        { status: 200 }\n      );\n    }\r\n\r\n    return NextResponse.json(\r\n      {\n        ok: true,\n        symbol,\n        mode,\n        ...parsed,\n        snapshot,\n        plan,\n        execution,\n        account,\n        positions,\n        equityPoint,\n        analyzer: { http_status: ar.status },\n      },\n      { status: 200 }\r\n    );\r\n  } catch (e) {\r\n    return NextResponse.json({ ok: false, error: (e as Error)?.message ?? \"Unknown error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}