{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/trader/app/api/outlook/route.ts"],"sourcesContent":["import \"server-only\";\nimport { NextResponse } from \"next/server\";\nimport OpenAI from \"openai\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nfunction env(name: string): string {\n  const v = process.env[name];\n  if (!v) throw new Error(`Missing env var: ${name}`);\n  return v;\n}\n\nfunction openaiClient() {\n  return new OpenAI({ apiKey: env(\"OPENAI_API_KEY\") });\n}\n\nfunction sbAdmin() {\n  return createClient(env(\"SUPABASE_URL\"), env(\"SUPABASE_SERVICE_ROLE_KEY\"), {\n    auth: { persistSession: false },\n  });\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n    const accountId = String(body.accountId ?? \"\").trim();\n    const livePriceOverride = Number(body.livePrice ?? NaN);\n    const analyzeUrl = new URL(\"/api/analyze\", req.url);\n    const ar = await fetch(analyzeUrl.toString(), {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({\n        symbol: body.symbol,\n        mode: body.mode,\n        timeframes: body.timeframes,\n        lookback: body.lookback,\n        equityUsd: body.equityUsd,\n        aggressive: body.aggressive,\n        constraints: body.constraints,\n        ltfPlan: body.ltfPlan,\n        wsProbe: { durationMs: 500, maxMessages: 500 },\n      }),\n    });\n\n    const analyzeJson = await ar.json().catch(() => null);\n    if (!ar.ok || !analyzeJson?.ok) {\n      return NextResponse.json(\n        { ok: false, error: analyzeJson?.error ?? \"analyze_failed\", raw: analyzeJson },\n        { status: 200 }\n      );\n    }\n\n    const snapshot = analyzeJson.snapshot ?? {};\n    const plan = analyzeJson.plan ?? {};\n    const gate = analyzeJson.gate ?? {};\n    const verdict = analyzeJson.verdict ?? {};\n    const markPrice = Number.isFinite(livePriceOverride) && livePriceOverride > 0\n      ? livePriceOverride\n      : Number(snapshot.price_live ?? snapshot.price ?? 0);\n\n    let account: any = null;\n    let positions: any[] = [];\n    let equityPoint: any = null;\n    if (accountId) {\n      try {\n        const sb = sbAdmin();\n        const { data: acct } = await sb\n          .from(\"trade_accounts\")\n          .select(\"id,cash_balance\")\n          .eq(\"id\", accountId)\n          .maybeSingle();\n        account = acct ?? null;\n\n        const { data: pos } = await sb\n          .from(\"trade_positions\")\n          .select(\"symbol,qty,avg_entry_price,realized_pnl_usd,updated_at\")\n          .eq(\"account_id\", accountId);\n        positions = Array.isArray(pos) ? pos : [];\n\n        const { data: riskRows } = await sb\n          .from(\"position_risk\")\n          .select(\"symbol,stop_price,max_loss_pct\")\n          .eq(\"account_id\", accountId);\n        const riskMap = new Map<string, any>();\n        for (const r of riskRows ?? []) riskMap.set(r.symbol, r);\n        positions = positions.map((p) => {\n          const r = riskMap.get(p.symbol);\n          return r ? { ...p, stop_price: r.stop_price, max_loss_pct: r.max_loss_pct } : p;\n        });\n\n        const { data: eq } = await sb\n          .from(\"trade_equity_points\")\n          .select(\"created_at,equity_usd,cash_usd,note\")\n          .eq(\"account_id\", accountId)\n          .order(\"created_at\", { ascending: false })\n          .limit(1);\n        equityPoint = Array.isArray(eq) && eq.length ? eq[0] : null;\n      } catch {\n        // ignore\n      }\n    }\n\n    const fallback =\n      `- Price: ${snapshot.price ?? \"—\"} (live ${snapshot.price_live ?? \"—\"})\\n` +\n      (accountId\n        ? `- Account: cash=${account?.cash_balance ?? \"—\"} equity=${equityPoint?.equity_usd ?? \"—\"}\\n`\n        : \"\") +\n      (positions.length\n        ? `- Positions: ${positions\n            .map((p) => {\n              const qty = Number(p.qty ?? 0);\n              const avg = Number(p.avg_entry_price ?? 0);\n              const upnl =\n                markPrice > 0 && Number.isFinite(qty) && Number.isFinite(avg)\n                  ? (markPrice - avg) * qty\n                  : null;\n              return `${p.symbol} qty=${qty} avg=${avg} uPnL=${upnl ?? \"—\"}`;\n            })\n            .join(\" | \")}\\n`\n        : \"\") +\n      `- Gate: ${gate.blocked ? \"BLOCKED\" : \"PASS\"} ${Array.isArray(gate.higherTimeframesUsed) ? gate.higherTimeframesUsed.join(\"+\") : \"\"}\\n` +\n      `- Plan: ${plan.action ?? \"NO_TRADE\"} (lev ${plan.leverage ?? \"—\"}x)\\n` +\n      `- Stop: ${plan.stop?.price ?? \"—\"} · Targets: ${Array.isArray(plan.targets) ? plan.targets.map((t: any) => t.price).join(\", \") : \"—\"}\\n` +\n      `- Verdict: ${verdict.ok ? \"OK\" : \"NO_TRADE\"} · RR: ${verdict.rr ?? \"—\"}`;\n\n    const ai = openaiClient();\n    const model = process.env.OPENAI_CHAT_MODEL || \"gpt-4o-mini\";\n\n    // Deterministic position/plan summary (always shown)\n    const posLines = positions.length\n      ? positions.map((p) => {\n          const qty = Number(p.qty ?? 0);\n          const avg = Number(p.avg_entry_price ?? 0);\n          const upnl =\n            markPrice > 0 && Number.isFinite(qty) && Number.isFinite(avg)\n              ? (markPrice - avg) * qty\n              : null;\n          const stop = p.stop_price ?? null;\n          const side = qty > 0 ? \"LONG\" : qty < 0 ? \"SHORT\" : \"FLAT\";\n          return `- Position: ${p.symbol} ${side} qty=${qty.toFixed(6)} avg=${avg.toFixed(2)} uPnL=${upnl == null ? \"—\" : upnl.toFixed(2)} stop=${stop ?? \"—\"}`;\n        })\n      : [\"- Position: none\"];\n\n    const planLine =\n      `- Plan: ${plan.action ?? \"NO_TRADE\"} entry=${plan.entry?.type ?? \"—\"} ` +\n      `stop=${plan.stop?.price ?? \"—\"} targets=${Array.isArray(plan.targets) ? plan.targets.map((t: any) => t.price).join(\", \") : \"—\"}`;\n\n    const intentLine = positions.length\n      ? `- Position action: ${plan.action === \"NO_TRADE\" ? \"HOLD\" : \"ADD/ADJUST\"}`\n      : `- Position action: ${plan.action === \"NO_TRADE\" ? \"WAIT\" : \"ENTER\"}`;\n\n    const reasonLine =\n      `- Reasoning: gate=${gate.blocked ? \"BLOCKED\" : \"PASS\"} ` +\n      `setup=${snapshot?.setup?.setupType ?? \"—\"} ` +\n      `bias=${snapshot?.setup?.bias ?? \"—\"} ` +\n      `verdict=${verdict.ok ? \"OK\" : \"NO_TRADE\"}`;\n\n    const directional =\n      `- Directional bias: ${snapshot?.setup?.bias ?? \"NEUTRAL\"} (short considered=${plan.action === \"SHORT\" ? \"yes\" : \"no\"})`;\n\n    let aiOutlook = \"\";\n    try {\n      const sys =\n        \"You are an assistant in a trading app. Provide 2-3 short bullets about near-term market context only. \" +\n        \"Do not restate position/plan/stop; that is already handled.\";\n      const user = { snapshot, gate, verdict, markPrice };\n      const resp: any = await ai.responses.create({\n        model,\n        temperature: 0.2,\n        max_output_tokens: 180,\n        instructions: sys,\n        input: JSON.stringify(user),\n      });\n      aiOutlook = String(resp.output_text ?? \"\").trim();\n    } catch {\n      // ignore, use deterministic summary only\n    }\n\n    const combined = [\n      ...posLines,\n      planLine,\n      intentLine,\n      reasonLine,\n      directional,\n      aiOutlook ? `- Market context: ${aiOutlook.replace(/\\n+/g, \" \")}` : null,\n    ]\n      .filter(Boolean)\n      .join(\"\\n\");\n\n    return NextResponse.json({ ok: true, outlook: combined }, { status: 200 });\n  } catch (e) {\n    return NextResponse.json({ ok: false, error: (e as Error).message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AAAA;AACA;;;;;AAEO,MAAM,UAAU;AAChB,MAAM,UAAU;AAChB,MAAM,aAAa;AAE1B,SAAS,IAAI,IAAY;IACvB,MAAM,IAAI,QAAQ,GAAG,CAAC,KAAK;IAC3B,IAAI,CAAC,GAAG,MAAM,IAAI,MAAM,CAAC,iBAAiB,EAAE,MAAM;IAClD,OAAO;AACT;AAEA,SAAS;IACP,OAAO,IAAI,mLAAM,CAAC;QAAE,QAAQ,IAAI;IAAkB;AACpD;AAEA,SAAS;IACP,OAAO,IAAA,gMAAY,EAAC,IAAI,iBAAiB,IAAI,8BAA8B;QACzE,MAAM;YAAE,gBAAgB;QAAM;IAChC;AACF;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,YAAY,OAAO,KAAK,SAAS,IAAI,IAAI,IAAI;QACnD,MAAM,oBAAoB,OAAO,KAAK,SAAS,IAAI;QACnD,MAAM,aAAa,IAAI,IAAI,gBAAgB,IAAI,GAAG;QAClD,MAAM,KAAK,MAAM,MAAM,WAAW,QAAQ,IAAI;YAC5C,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,MAAM,KAAK,SAAS,CAAC;gBACnB,QAAQ,KAAK,MAAM;gBACnB,MAAM,KAAK,IAAI;gBACf,YAAY,KAAK,UAAU;gBAC3B,UAAU,KAAK,QAAQ;gBACvB,WAAW,KAAK,SAAS;gBACzB,YAAY,KAAK,UAAU;gBAC3B,aAAa,KAAK,WAAW;gBAC7B,SAAS,KAAK,OAAO;gBACrB,SAAS;oBAAE,YAAY;oBAAK,aAAa;gBAAI;YAC/C;QACF;QAEA,MAAM,cAAc,MAAM,GAAG,IAAI,GAAG,KAAK,CAAC,IAAM;QAChD,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,aAAa,IAAI;YAC9B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,OAAO,aAAa,SAAS;gBAAkB,KAAK;YAAY,GAC7E;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,WAAW,YAAY,QAAQ,IAAI,CAAC;QAC1C,MAAM,OAAO,YAAY,IAAI,IAAI,CAAC;QAClC,MAAM,OAAO,YAAY,IAAI,IAAI,CAAC;QAClC,MAAM,UAAU,YAAY,OAAO,IAAI,CAAC;QACxC,MAAM,YAAY,OAAO,QAAQ,CAAC,sBAAsB,oBAAoB,IACxE,oBACA,OAAO,SAAS,UAAU,IAAI,SAAS,KAAK,IAAI;QAEpD,IAAI,UAAe;QACnB,IAAI,YAAmB,EAAE;QACzB,IAAI,cAAmB;QACvB,IAAI,WAAW;YACb,IAAI;gBACF,MAAM,KAAK;gBACX,MAAM,EAAE,MAAM,IAAI,EAAE,GAAG,MAAM,GAC1B,IAAI,CAAC,kBACL,MAAM,CAAC,mBACP,EAAE,CAAC,MAAM,WACT,WAAW;gBACd,UAAU,QAAQ;gBAElB,MAAM,EAAE,MAAM,GAAG,EAAE,GAAG,MAAM,GACzB,IAAI,CAAC,mBACL,MAAM,CAAC,0DACP,EAAE,CAAC,cAAc;gBACpB,YAAY,MAAM,OAAO,CAAC,OAAO,MAAM,EAAE;gBAEzC,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,GAC9B,IAAI,CAAC,iBACL,MAAM,CAAC,kCACP,EAAE,CAAC,cAAc;gBACpB,MAAM,UAAU,IAAI;gBACpB,KAAK,MAAM,KAAK,YAAY,EAAE,CAAE,QAAQ,GAAG,CAAC,EAAE,MAAM,EAAE;gBACtD,YAAY,UAAU,GAAG,CAAC,CAAC;oBACzB,MAAM,IAAI,QAAQ,GAAG,CAAC,EAAE,MAAM;oBAC9B,OAAO,IAAI;wBAAE,GAAG,CAAC;wBAAE,YAAY,EAAE,UAAU;wBAAE,cAAc,EAAE,YAAY;oBAAC,IAAI;gBAChF;gBAEA,MAAM,EAAE,MAAM,EAAE,EAAE,GAAG,MAAM,GACxB,IAAI,CAAC,uBACL,MAAM,CAAC,uCACP,EAAE,CAAC,cAAc,WACjB,KAAK,CAAC,cAAc;oBAAE,WAAW;gBAAM,GACvC,KAAK,CAAC;gBACT,cAAc,MAAM,OAAO,CAAC,OAAO,GAAG,MAAM,GAAG,EAAE,CAAC,EAAE,GAAG;YACzD,EAAE,OAAM;YACN,SAAS;YACX;QACF;QAEA,MAAM,WACJ,CAAC,SAAS,EAAE,SAAS,KAAK,IAAI,IAAI,OAAO,EAAE,SAAS,UAAU,IAAI,IAAI,GAAG,CAAC,GAC1E,CAAC,YACG,CAAC,gBAAgB,EAAE,SAAS,gBAAgB,IAAI,QAAQ,EAAE,aAAa,cAAc,IAAI,EAAE,CAAC,GAC5F,EAAE,IACN,CAAC,UAAU,MAAM,GACb,CAAC,aAAa,EAAE,UACb,GAAG,CAAC,CAAC;YACJ,MAAM,MAAM,OAAO,EAAE,GAAG,IAAI;YAC5B,MAAM,MAAM,OAAO,EAAE,eAAe,IAAI;YACxC,MAAM,OACJ,YAAY,KAAK,OAAO,QAAQ,CAAC,QAAQ,OAAO,QAAQ,CAAC,OACrD,CAAC,YAAY,GAAG,IAAI,MACpB;YACN,OAAO,GAAG,EAAE,MAAM,CAAC,KAAK,EAAE,IAAI,KAAK,EAAE,IAAI,MAAM,EAAE,QAAQ,KAAK;QAChE,GACC,IAAI,CAAC,OAAO,EAAE,CAAC,GAClB,EAAE,IACN,CAAC,QAAQ,EAAE,KAAK,OAAO,GAAG,YAAY,OAAO,CAAC,EAAE,MAAM,OAAO,CAAC,KAAK,oBAAoB,IAAI,KAAK,oBAAoB,CAAC,IAAI,CAAC,OAAO,GAAG,EAAE,CAAC,GACvI,CAAC,QAAQ,EAAE,KAAK,MAAM,IAAI,WAAW,MAAM,EAAE,KAAK,QAAQ,IAAI,IAAI,IAAI,CAAC,GACvE,CAAC,QAAQ,EAAE,KAAK,IAAI,EAAE,SAAS,IAAI,YAAY,EAAE,MAAM,OAAO,CAAC,KAAK,OAAO,IAAI,KAAK,OAAO,CAAC,GAAG,CAAC,CAAC,IAAW,EAAE,KAAK,EAAE,IAAI,CAAC,QAAQ,IAAI,EAAE,CAAC,GACzI,CAAC,WAAW,EAAE,QAAQ,EAAE,GAAG,OAAO,WAAW,OAAO,EAAE,QAAQ,EAAE,IAAI,KAAK;QAE3E,MAAM,KAAK;QACX,MAAM,QAAQ,QAAQ,GAAG,CAAC,iBAAiB,IAAI;QAE/C,qDAAqD;QACrD,MAAM,WAAW,UAAU,MAAM,GAC7B,UAAU,GAAG,CAAC,CAAC;YACb,MAAM,MAAM,OAAO,EAAE,GAAG,IAAI;YAC5B,MAAM,MAAM,OAAO,EAAE,eAAe,IAAI;YACxC,MAAM,OACJ,YAAY,KAAK,OAAO,QAAQ,CAAC,QAAQ,OAAO,QAAQ,CAAC,OACrD,CAAC,YAAY,GAAG,IAAI,MACpB;YACN,MAAM,OAAO,EAAE,UAAU,IAAI;YAC7B,MAAM,OAAO,MAAM,IAAI,SAAS,MAAM,IAAI,UAAU;YACpD,OAAO,CAAC,YAAY,EAAE,EAAE,MAAM,CAAC,CAAC,EAAE,KAAK,KAAK,EAAE,IAAI,OAAO,CAAC,GAAG,KAAK,EAAE,IAAI,OAAO,CAAC,GAAG,MAAM,EAAE,QAAQ,OAAO,MAAM,KAAK,OAAO,CAAC,GAAG,MAAM,EAAE,QAAQ,KAAK;QACvJ,KACA;YAAC;SAAmB;QAExB,MAAM,WACJ,CAAC,QAAQ,EAAE,KAAK,MAAM,IAAI,WAAW,OAAO,EAAE,KAAK,KAAK,EAAE,QAAQ,IAAI,CAAC,CAAC,GACxE,CAAC,KAAK,EAAE,KAAK,IAAI,EAAE,SAAS,IAAI,SAAS,EAAE,MAAM,OAAO,CAAC,KAAK,OAAO,IAAI,KAAK,OAAO,CAAC,GAAG,CAAC,CAAC,IAAW,EAAE,KAAK,EAAE,IAAI,CAAC,QAAQ,KAAK;QAEnI,MAAM,aAAa,UAAU,MAAM,GAC/B,CAAC,mBAAmB,EAAE,KAAK,MAAM,KAAK,aAAa,SAAS,cAAc,GAC1E,CAAC,mBAAmB,EAAE,KAAK,MAAM,KAAK,aAAa,SAAS,SAAS;QAEzE,MAAM,aACJ,CAAC,kBAAkB,EAAE,KAAK,OAAO,GAAG,YAAY,OAAO,CAAC,CAAC,GACzD,CAAC,MAAM,EAAE,UAAU,OAAO,aAAa,IAAI,CAAC,CAAC,GAC7C,CAAC,KAAK,EAAE,UAAU,OAAO,QAAQ,IAAI,CAAC,CAAC,GACvC,CAAC,QAAQ,EAAE,QAAQ,EAAE,GAAG,OAAO,YAAY;QAE7C,MAAM,cACJ,CAAC,oBAAoB,EAAE,UAAU,OAAO,QAAQ,UAAU,mBAAmB,EAAE,KAAK,MAAM,KAAK,UAAU,QAAQ,KAAK,CAAC,CAAC;QAE1H,IAAI,YAAY;QAChB,IAAI;YACF,MAAM,MACJ,2GACA;YACF,MAAM,OAAO;gBAAE;gBAAU;gBAAM;gBAAS;YAAU;YAClD,MAAM,OAAY,MAAM,GAAG,SAAS,CAAC,MAAM,CAAC;gBAC1C;gBACA,aAAa;gBACb,mBAAmB;gBACnB,cAAc;gBACd,OAAO,KAAK,SAAS,CAAC;YACxB;YACA,YAAY,OAAO,KAAK,WAAW,IAAI,IAAI,IAAI;QACjD,EAAE,OAAM;QACN,yCAAyC;QAC3C;QAEA,MAAM,WAAW;eACZ;YACH;YACA;YACA;YACA;YACA,YAAY,CAAC,kBAAkB,EAAE,UAAU,OAAO,CAAC,QAAQ,MAAM,GAAG;SACrE,CACE,MAAM,CAAC,SACP,IAAI,CAAC;QAER,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM,SAAS;QAAS,GAAG;YAAE,QAAQ;QAAI;IAC1E,EAAE,OAAO,GAAG;QACV,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO,AAAC,EAAY,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACrF;AACF"}}]
}