{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/trader/app/api/analyze/route.ts"],"sourcesContent":["import \"server-only\";\nimport { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport OpenAI from \"openai\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\ntype Timeframe = \"15m\" | \"1h\" | \"4h\" | \"1d\";\n\ntype CandleRowRaw = {\n  open_time: string;\n  open: number | string;\n  high: number | string;\n  low: number | string;\n  close: number | string;\n  volume: number | string;\n  ema20: number | string | null;\n  ema50: number | string | null;\n  ema200: number | string | null;\n  rsi14: number | string | null;\n};\n\ntype CandleRow = {\n  open_time: string;\n  open: number;\n  high: number;\n  low: number;\n  close: number;\n  volume: number;\n  ema20: number | null;\n  ema50: number | null;\n  ema200: number | null;\n  rsi14: number | null;\n};\n\ntype TimeframeSummary = {\n  timeframe: Timeframe;\n  bars: number;\n  close: number | null;\n  changePct: number | null;\n  ema20: number | null;\n  ema50: number | null;\n  ema200: number | null;\n  rsi14: number | null;\n  atr: number | null;\n  atrPct: number | null;\n  swingHigh: number | null;\n  swingLow: number | null;\n  trend: string;\n  volatilityPct: number | null;\n};\n\ntype DerivedSnapshot = {\n  regime: string;\n  momentum: string;\n  volatility: string;\n  keyLevels: { support: number[]; resistance: number[]; pivots: number[] };\n  confidenceScore: number;\n};\n\ntype StrategistResponse = {\n  ok: boolean;\n  error?: string;\n  mode?: \"LTF\" | \"HTF\";\n  symbol?: string;\n  generatedAt?: string;\n  model?: \"openai\" | \"fallback\";\n  modelError?: string;\n  live?: {\n    price: number | null;\n    change24hPct: number | null;\n    high24h: number | null;\n    low24h: number | null;\n    volume24h: number | null;\n    timestamp: string | null;\n  };\n  timeframes?: Partial<Record<Timeframe, TimeframeSummary>>;\n  derived?: DerivedSnapshot;\n  analysis?: any;\n  strategies?: any;\n};\n\nfunction requireEnv(name: string): string {\n  const value = process.env[name];\n  if (!value) throw new Error(`Missing env var: ${name}`);\n  return value;\n}\n\nfunction sbAdmin() {\n  const url = requireEnv(\"SUPABASE_URL\");\n  const key = requireEnv(\"SUPABASE_SERVICE_ROLE_KEY\");\n  return createClient(url, key, { auth: { persistSession: false } });\n}\n\nfunction openaiClient() {\n  const apiKey = requireEnv(\"OPENAI_API_KEY\");\n  return new OpenAI({ apiKey });\n}\n\nfunction clamp(n: number, lo: number, hi: number) {\n  if (!Number.isFinite(n)) return lo;\n  return Math.min(hi, Math.max(lo, n));\n}\n\nfunction safeNum(value: any): number | null {\n  if (value == null) return null;\n  const num = typeof value === \"number\" ? value : Number(value);\n  return Number.isFinite(num) ? num : null;\n}\n\nfunction toDbSymbol(symbol: string) {\n  const s = (symbol || \"\").trim().toUpperCase();\n  if (!s) return \"BTCUSDT-PERP\";\n  if (s.endsWith(\"-PERP\")) return s;\n  return `${s}-PERP`;\n}\n\nfunction toBinanceSymbol(symbol: string) {\n  const s = (symbol || \"\").trim().toUpperCase();\n  if (!s) return \"BTCUSDT\";\n  return s.replace(/-PERP$/i, \"\").replace(/[^A-Z0-9]/g, \"\");\n}\n\nasync function fetchCandles(sb: ReturnType<typeof sbAdmin>, symbol: string, tf: Timeframe, lookback: number) {\n  const { data, error } = await sb\n    .from(\"candles\")\n    .select(\"open_time,open,high,low,close,volume,ema20,ema50,ema200,rsi14\")\n    .eq(\"symbol\", symbol)\n    .eq(\"timeframe\", tf)\n    .order(\"open_time\", { ascending: false })\n    .limit(lookback);\n\n  if (error) throw new Error(`candles query failed: ${error.message}`);\n\n  return (data ?? [])\n    .map((row: CandleRowRaw): CandleRow | null => {\n      const open = safeNum(row.open);\n      const high = safeNum(row.high);\n      const low = safeNum(row.low);\n      const close = safeNum(row.close);\n      const volume = safeNum(row.volume);\n      if (open == null || high == null || low == null || close == null || volume == null) return null;\n\n      return {\n        open_time: row.open_time,\n        open,\n        high,\n        low,\n        close,\n        volume,\n        ema20: safeNum(row.ema20),\n        ema50: safeNum(row.ema50),\n        ema200: safeNum(row.ema200),\n        rsi14: safeNum(row.rsi14),\n      };\n    })\n    .filter((row): row is CandleRow => row != null)\n    .reverse();\n}\n\nfunction computeAtr(rows: CandleRow[], period = 14): number | null {\n  if (rows.length < period + 1) return null;\n  let sum = 0;\n  let count = 0;\n  for (let i = rows.length - period; i < rows.length; i += 1) {\n    const current = rows[i];\n    const prev = rows[i - 1];\n    if (!prev) continue;\n    const tr = Math.max(\n      current.high - current.low,\n      Math.abs(current.high - prev.close),\n      Math.abs(current.low - prev.close)\n    );\n    if (Number.isFinite(tr)) {\n      sum += tr;\n      count += 1;\n    }\n  }\n  return count ? sum / count : null;\n}\n\nfunction computeVolatilityPct(rows: CandleRow[], period = 30): number | null {\n  if (rows.length < period + 1) return null;\n  const start = rows.length - period - 1;\n  const returns: number[] = [];\n  for (let i = start + 1; i < rows.length; i += 1) {\n    const prev = rows[i - 1];\n    const current = rows[i];\n    if (!prev || !current || prev.close <= 0) continue;\n    returns.push((current.close - prev.close) / prev.close);\n  }\n  if (!returns.length) return null;\n  const mean = returns.reduce((sum, r) => sum + r, 0) / returns.length;\n  const variance = returns.reduce((sum, r) => sum + (r - mean) ** 2, 0) / returns.length;\n  return Math.sqrt(variance) * 100;\n}\n\nfunction computeSwing(rows: CandleRow[], lookback = 50) {\n  if (!rows.length) return { high: null, low: null };\n  const slice = rows.slice(-lookback);\n  const high = Math.max(...slice.map((r) => r.high));\n  const low = Math.min(...slice.map((r) => r.low));\n  return { high, low };\n}\n\nfunction computeTrend(ema20: number | null, ema50: number | null, ema200: number | null) {\n  if (ema20 == null || ema50 == null || ema200 == null) return \"mixed\";\n  if (ema20 > ema50 && ema50 > ema200) return \"bullish\";\n  if (ema20 < ema50 && ema50 < ema200) return \"bearish\";\n  if (ema20 > ema50) return \"lean bullish\";\n  if (ema20 < ema50) return \"lean bearish\";\n  return \"range\";\n}\n\nfunction summarizeTimeframe(tf: Timeframe, rows: CandleRow[]): TimeframeSummary {\n  if (!rows.length) {\n    return {\n      timeframe: tf,\n      bars: 0,\n      close: null,\n      changePct: null,\n      ema20: null,\n      ema50: null,\n      ema200: null,\n      rsi14: null,\n      atr: null,\n      atrPct: null,\n      swingHigh: null,\n      swingLow: null,\n      trend: \"missing\",\n      volatilityPct: null,\n    };\n  }\n  const last = rows[rows.length - 1];\n  const prev = rows[rows.length - 2] ?? null;\n  const changePct = prev ? ((last.close - prev.close) / prev.close) * 100 : null;\n  const atr = computeAtr(rows, 14);\n  const atrPct = atr && last.close > 0 ? (atr / last.close) * 100 : null;\n  const { high, low } = computeSwing(rows, 50);\n  return {\n    timeframe: tf,\n    bars: rows.length,\n    close: last.close,\n    changePct,\n    ema20: last.ema20,\n    ema50: last.ema50,\n    ema200: last.ema200,\n    rsi14: last.rsi14,\n    atr,\n    atrPct,\n    swingHigh: high,\n    swingLow: low,\n    trend: computeTrend(last.ema20, last.ema50, last.ema200),\n    volatilityPct: computeVolatilityPct(rows, 30),\n  };\n}\n\nfunction uniqueNumbers(values: Array<number | null | undefined>) {\n  const out: number[] = [];\n  const seen = new Set<string>();\n  for (const value of values) {\n    if (value == null || !Number.isFinite(value)) continue;\n    const key = value.toFixed(2);\n    if (!seen.has(key)) {\n      seen.add(key);\n      out.push(value);\n    }\n  }\n  return out;\n}\n\nfunction deriveSnapshot(timeframes: Partial<Record<Timeframe, TimeframeSummary>>): DerivedSnapshot {\n  const tf4h = timeframes[\"4h\"];\n  const tf1d = timeframes[\"1d\"];\n  const tf1h = timeframes[\"1h\"];\n\n  const trendVotes = [tf4h?.trend, tf1d?.trend].filter(Boolean);\n  const bullishVotes = trendVotes.filter((t) => t?.includes(\"bull\")).length;\n  const bearishVotes = trendVotes.filter((t) => t?.includes(\"bear\")).length;\n\n  const regime =\n    bullishVotes >= 2 ? \"bullish\" : bearishVotes >= 2 ? \"bearish\" : bullishVotes && bearishVotes ? \"mixed\" : \"range\";\n\n  const rsi = tf1h?.rsi14 ?? tf4h?.rsi14 ?? null;\n  const momentum = rsi == null ? \"unknown\" : rsi >= 60 ? \"positive\" : rsi <= 40 ? \"negative\" : \"neutral\";\n\n  const vol = tf1h?.volatilityPct ?? tf4h?.volatilityPct ?? null;\n  const volatility = vol == null ? \"unknown\" : vol >= 4 ? \"high\" : vol >= 2.5 ? \"elevated\" : \"calm\";\n\n  const support = uniqueNumbers([tf4h?.swingLow, tf1d?.swingLow, tf4h?.ema200, tf1d?.ema200]);\n  const resistance = uniqueNumbers([tf4h?.swingHigh, tf1d?.swingHigh, tf4h?.ema50, tf1d?.ema50]);\n  const pivots = uniqueNumbers([tf4h?.ema20, tf1d?.ema20, tf1h?.ema20]);\n\n  const confidenceScore = clamp(50 + bullishVotes * 15 + bearishVotes * 15, 0, 100);\n\n  return {\n    regime,\n    momentum,\n    volatility,\n    keyLevels: { support, resistance, pivots },\n    confidenceScore,\n  };\n}\n\nasync function fetchBinanceLive(symbol: string) {\n  const url = `https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`;\n  const res = await fetch(url, { cache: \"no-store\" });\n  if (!res.ok) throw new Error(`Binance fetch failed: ${res.status}`);\n  const data: any = await res.json();\n  return {\n    price: safeNum(data.lastPrice),\n    change24hPct: safeNum(data.priceChangePercent),\n    high24h: safeNum(data.highPrice),\n    low24h: safeNum(data.lowPrice),\n    volume24h: safeNum(data.quoteVolume),\n    timestamp: data.closeTime ? new Date(data.closeTime).toISOString() : null,\n  };\n}\n\nconst responseSchema = {\n  type: \"object\",\n  additionalProperties: false,\n  properties: {\n    analysis: {\n      type: \"object\",\n      additionalProperties: false,\n      properties: {\n        headline: { type: \"string\" },\n        summary: { type: \"string\" },\n        marketRegime: { type: \"string\" },\n        momentum: { type: \"string\" },\n        volatility: { type: \"string\" },\n        keyLevels: {\n          type: \"object\",\n          additionalProperties: false,\n          properties: {\n            support: { type: \"array\", items: { type: \"number\" } },\n            resistance: { type: \"array\", items: { type: \"number\" } },\n            pivots: { type: \"array\", items: { type: \"number\" } },\n          },\n          required: [\"support\", \"resistance\", \"pivots\"],\n        },\n        riskNotes: { type: \"array\", items: { type: \"string\" } },\n        confidence: {\n          type: \"object\",\n          additionalProperties: false,\n          properties: {\n            score: { type: \"number\" },\n            rationale: { type: \"array\", items: { type: \"string\" } },\n          },\n          required: [\"score\", \"rationale\"],\n        },\n      },\n      required: [\"headline\", \"summary\", \"marketRegime\", \"momentum\", \"volatility\", \"keyLevels\", \"riskNotes\", \"confidence\"],\n    },\n    strategies: {\n      type: \"object\",\n      additionalProperties: false,\n      properties: {\n        intraday: { $ref: \"#/$defs/strategy\" },\n        scalp: { $ref: \"#/$defs/strategy\" },\n        swing: { $ref: \"#/$defs/strategy\" },\n      },\n      required: [\"intraday\", \"scalp\", \"swing\"],\n    },\n  },\n  required: [\"analysis\", \"strategies\"],\n  $defs: {\n    strategy: {\n      type: \"object\",\n      additionalProperties: false,\n      properties: {\n        name: { type: \"string\" },\n        bias: { type: \"string\", enum: [\"LONG\", \"SHORT\", \"NEUTRAL\"] },\n        setup: { type: \"string\" },\n        entry: {\n          type: \"object\",\n          additionalProperties: false,\n          properties: {\n            type: { type: \"string\", enum: [\"market\", \"limit\", \"stop\"] },\n            price: { type: [\"number\", \"null\"] },\n            zone: {\n              type: [\"object\", \"null\"],\n              additionalProperties: false,\n              properties: { lo: { type: \"number\" }, hi: { type: \"number\" } },\n              required: [\"lo\", \"hi\"],\n            },\n          },\n          required: [\"type\", \"price\", \"zone\"],\n        },\n        stop: { type: \"number\" },\n        targets: { type: \"array\", items: { type: \"number\" } },\n        timeHorizon: { type: \"string\" },\n        positionSizing: { type: \"string\" },\n        invalidation: { type: \"string\" },\n        rationale: { type: \"array\", items: { type: \"string\" } },\n        confidence: { type: \"number\" },\n      },\n      required: [\n        \"name\",\n        \"bias\",\n        \"setup\",\n        \"entry\",\n        \"stop\",\n        \"targets\",\n        \"timeHorizon\",\n        \"positionSizing\",\n        \"invalidation\",\n        \"rationale\",\n        \"confidence\",\n      ],\n    },\n  },\n};\n\nfunction extractJsonObject(text: string) {\n  const trimmed = text.trim();\n  if (trimmed.startsWith(\"{\") && trimmed.endsWith(\"}\")) return trimmed;\n  const first = trimmed.indexOf(\"{\");\n  const last = trimmed.lastIndexOf(\"}\");\n  if (first >= 0 && last > first) return trimmed.slice(first, last + 1);\n  return null;\n}\n\nfunction buildFallbackAnalysis(derived: DerivedSnapshot) {\n  return {\n    headline: `BTC regime: ${derived.regime} with ${derived.momentum} momentum`,\n    summary:\n      \"Fallback analysis uses computed trend, momentum, and volatility metrics. Connect an OpenAI model for full narrative output.\",\n    marketRegime: derived.regime,\n    momentum: derived.momentum,\n    volatility: derived.volatility,\n    keyLevels: derived.keyLevels,\n    riskNotes: [\"Model output unavailable. Validate levels and conditions manually before trading.\"],\n    confidence: {\n      score: derived.confidenceScore,\n      rationale: [\"Score derived from multi-timeframe trend alignment.\"],\n    },\n  };\n}\n\nfunction buildFallbackStrategies(price: number | null, derived: DerivedSnapshot) {\n  const bias = derived.regime === \"bullish\" ? \"LONG\" : derived.regime === \"bearish\" ? \"SHORT\" : \"NEUTRAL\";\n  const base = price && Number.isFinite(price) ? price : 0;\n  const buffer = base ? base * 0.01 : 0;\n  const stop = bias === \"LONG\" ? base - buffer : base + buffer;\n  const targets =\n    bias === \"SHORT\"\n      ? [base - buffer * 1.2, base - buffer * 2.4]\n      : [base + buffer * 1.2, base + buffer * 2.4];\n\n  const build = (name: string, horizon: string) => ({\n    name,\n    bias: bias as \"LONG\" | \"SHORT\" | \"NEUTRAL\",\n    setup: \"Trend-aligned pullback with confirmation.\",\n    entry: { type: \"limit\", price: base || undefined, zone: null },\n    stop: stop || 0,\n    targets,\n    timeHorizon: horizon,\n    positionSizing: \"Scale in with 25-35% size, tighten risk on confirmation.\",\n    invalidation: \"Break of the nearest swing level or EMA200.\",\n    rationale: [\"Uses regime bias and key swing levels from candles.\"],\n    confidence: derived.confidenceScore,\n  });\n\n  return {\n    intraday: build(\"Intraday Plan\", \"Minutes to hours\"),\n    scalp: build(\"Scalp Plan\", \"15-45 minutes\"),\n    swing: build(\"Mid/Long-Term Plan\", \"Days to weeks\"),\n  };\n}\n\nasync function callModel(payload: any) {\n  const client = openaiClient();\n  const model =\n    process.env.OPENAI_STRATEGIST_MODEL ||\n    process.env.OPENAI_TRADE_MODEL ||\n    process.env.OPENAI_CHAT_MODEL ||\n    \"gpt-4o\";\n\n  const response = await client.responses.create({\n    model,\n    temperature: 0.2,\n    max_output_tokens: 1200,\n    text: {\n      format: {\n        type: \"json_schema\",\n        name: \"btc_strategist\",\n        schema: responseSchema,\n        strict: true,\n      },\n    },\n    instructions:\n      \"You are an institutional crypto strategist. Use only the provided data. \" +\n      \"Generate a thorough Bitcoin analysis and three strategy playbooks: intraday, scalp, and mid/long-term. \" +\n      \"Include bias, entry, stop, targets, invalidation, and sizing guidance. \" +\n      \"Use numeric price levels from the input; do not invent data.\",\n    input: JSON.stringify(payload),\n  });\n\n  const text = String((response as any).output_text ?? \"\").trim();\n  const jsonText = extractJsonObject(text) ?? text;\n  return JSON.parse(jsonText);\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = (await req.json()) as { mode?: \"LTF\" | \"HTF\"; symbol?: string; lookback?: number };\n\n    const mode = body.mode === \"LTF\" ? \"LTF\" : \"HTF\";\n    const symbolInput = (body.symbol || \"BTCUSDT\").trim().toUpperCase();\n    const lookback = clamp(body.lookback ?? (mode === \"LTF\" ? 360 : 540), 240, 2000);\n\n    const dbSymbol = toDbSymbol(symbolInput);\n    const binanceSymbol = toBinanceSymbol(symbolInput);\n\n    const timeframes: Timeframe[] = mode === \"LTF\" ? [\"15m\", \"1h\", \"4h\"] : [\"1h\", \"4h\", \"1d\"];\n\n    const sb = sbAdmin();\n    const rowsByTf = await Promise.all(timeframes.map((tf) => fetchCandles(sb, dbSymbol, tf, lookback)));\n    const summaries = timeframes.reduce<Partial<Record<Timeframe, TimeframeSummary>>>((acc, tf, index) => {\n      acc[tf] = summarizeTimeframe(tf, rowsByTf[index]);\n      return acc;\n    }, {});\n\n    const live = await fetchBinanceLive(binanceSymbol);\n    const derived = deriveSnapshot(summaries);\n\n    const payload = {\n      symbol: symbolInput,\n      mode,\n      live,\n      timeframes: summaries,\n      derived,\n    };\n\n    let analysis: any = null;\n    let strategies: any = null;\n    let model: \"openai\" | \"fallback\" = \"fallback\";\n    let modelError: string | undefined;\n\n    try {\n      const modelOutput = await callModel(payload);\n      analysis = modelOutput.analysis;\n      strategies = modelOutput.strategies;\n      model = \"openai\";\n    } catch (err: any) {\n      modelError = err?.message || \"Model output unavailable.\";\n      analysis = buildFallbackAnalysis(derived);\n      strategies = buildFallbackStrategies(live.price, derived);\n    }\n\n    const response: StrategistResponse = {\n      ok: true,\n      mode,\n      symbol: symbolInput,\n      generatedAt: new Date().toISOString(),\n      model,\n      modelError,\n      live,\n      timeframes: summaries,\n      derived,\n      analysis,\n      strategies,\n    };\n\n    return NextResponse.json(response, { status: 200 });\n  } catch (err: any) {\n    return NextResponse.json({ ok: false, error: err?.message || \"Unknown error\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;AAAA;;;;;AAEO,MAAM,UAAU;AAChB,MAAM,UAAU;AAChB,MAAM,aAAa;AA6E1B,SAAS,WAAW,IAAY;IAC9B,MAAM,QAAQ,QAAQ,GAAG,CAAC,KAAK;IAC/B,IAAI,CAAC,OAAO,MAAM,IAAI,MAAM,CAAC,iBAAiB,EAAE,MAAM;IACtD,OAAO;AACT;AAEA,SAAS;IACP,MAAM,MAAM,WAAW;IACvB,MAAM,MAAM,WAAW;IACvB,OAAO,IAAA,gMAAY,EAAC,KAAK,KAAK;QAAE,MAAM;YAAE,gBAAgB;QAAM;IAAE;AAClE;AAEA,SAAS;IACP,MAAM,SAAS,WAAW;IAC1B,OAAO,IAAI,mLAAM,CAAC;QAAE;IAAO;AAC7B;AAEA,SAAS,MAAM,CAAS,EAAE,EAAU,EAAE,EAAU;IAC9C,IAAI,CAAC,OAAO,QAAQ,CAAC,IAAI,OAAO;IAChC,OAAO,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,IAAI;AACnC;AAEA,SAAS,QAAQ,KAAU;IACzB,IAAI,SAAS,MAAM,OAAO;IAC1B,MAAM,MAAM,OAAO,UAAU,WAAW,QAAQ,OAAO;IACvD,OAAO,OAAO,QAAQ,CAAC,OAAO,MAAM;AACtC;AAEA,SAAS,WAAW,MAAc;IAChC,MAAM,IAAI,CAAC,UAAU,EAAE,EAAE,IAAI,GAAG,WAAW;IAC3C,IAAI,CAAC,GAAG,OAAO;IACf,IAAI,EAAE,QAAQ,CAAC,UAAU,OAAO;IAChC,OAAO,GAAG,EAAE,KAAK,CAAC;AACpB;AAEA,SAAS,gBAAgB,MAAc;IACrC,MAAM,IAAI,CAAC,UAAU,EAAE,EAAE,IAAI,GAAG,WAAW;IAC3C,IAAI,CAAC,GAAG,OAAO;IACf,OAAO,EAAE,OAAO,CAAC,WAAW,IAAI,OAAO,CAAC,cAAc;AACxD;AAEA,eAAe,aAAa,EAA8B,EAAE,MAAc,EAAE,EAAa,EAAE,QAAgB;IACzG,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,GAC3B,IAAI,CAAC,WACL,MAAM,CAAC,iEACP,EAAE,CAAC,UAAU,QACb,EAAE,CAAC,aAAa,IAChB,KAAK,CAAC,aAAa;QAAE,WAAW;IAAM,GACtC,KAAK,CAAC;IAET,IAAI,OAAO,MAAM,IAAI,MAAM,CAAC,sBAAsB,EAAE,MAAM,OAAO,EAAE;IAEnE,OAAO,CAAC,QAAQ,EAAE,EACf,GAAG,CAAC,CAAC;QACJ,MAAM,OAAO,QAAQ,IAAI,IAAI;QAC7B,MAAM,OAAO,QAAQ,IAAI,IAAI;QAC7B,MAAM,MAAM,QAAQ,IAAI,GAAG;QAC3B,MAAM,QAAQ,QAAQ,IAAI,KAAK;QAC/B,MAAM,SAAS,QAAQ,IAAI,MAAM;QACjC,IAAI,QAAQ,QAAQ,QAAQ,QAAQ,OAAO,QAAQ,SAAS,QAAQ,UAAU,MAAM,OAAO;QAE3F,OAAO;YACL,WAAW,IAAI,SAAS;YACxB;YACA;YACA;YACA;YACA;YACA,OAAO,QAAQ,IAAI,KAAK;YACxB,OAAO,QAAQ,IAAI,KAAK;YACxB,QAAQ,QAAQ,IAAI,MAAM;YAC1B,OAAO,QAAQ,IAAI,KAAK;QAC1B;IACF,GACC,MAAM,CAAC,CAAC,MAA0B,OAAO,MACzC,OAAO;AACZ;AAEA,SAAS,WAAW,IAAiB,EAAE,SAAS,EAAE;IAChD,IAAI,KAAK,MAAM,GAAG,SAAS,GAAG,OAAO;IACrC,IAAI,MAAM;IACV,IAAI,QAAQ;IACZ,IAAK,IAAI,IAAI,KAAK,MAAM,GAAG,QAAQ,IAAI,KAAK,MAAM,EAAE,KAAK,EAAG;QAC1D,MAAM,UAAU,IAAI,CAAC,EAAE;QACvB,MAAM,OAAO,IAAI,CAAC,IAAI,EAAE;QACxB,IAAI,CAAC,MAAM;QACX,MAAM,KAAK,KAAK,GAAG,CACjB,QAAQ,IAAI,GAAG,QAAQ,GAAG,EAC1B,KAAK,GAAG,CAAC,QAAQ,IAAI,GAAG,KAAK,KAAK,GAClC,KAAK,GAAG,CAAC,QAAQ,GAAG,GAAG,KAAK,KAAK;QAEnC,IAAI,OAAO,QAAQ,CAAC,KAAK;YACvB,OAAO;YACP,SAAS;QACX;IACF;IACA,OAAO,QAAQ,MAAM,QAAQ;AAC/B;AAEA,SAAS,qBAAqB,IAAiB,EAAE,SAAS,EAAE;IAC1D,IAAI,KAAK,MAAM,GAAG,SAAS,GAAG,OAAO;IACrC,MAAM,QAAQ,KAAK,MAAM,GAAG,SAAS;IACrC,MAAM,UAAoB,EAAE;IAC5B,IAAK,IAAI,IAAI,QAAQ,GAAG,IAAI,KAAK,MAAM,EAAE,KAAK,EAAG;QAC/C,MAAM,OAAO,IAAI,CAAC,IAAI,EAAE;QACxB,MAAM,UAAU,IAAI,CAAC,EAAE;QACvB,IAAI,CAAC,QAAQ,CAAC,WAAW,KAAK,KAAK,IAAI,GAAG;QAC1C,QAAQ,IAAI,CAAC,CAAC,QAAQ,KAAK,GAAG,KAAK,KAAK,IAAI,KAAK,KAAK;IACxD;IACA,IAAI,CAAC,QAAQ,MAAM,EAAE,OAAO;IAC5B,MAAM,OAAO,QAAQ,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,GAAG,KAAK,QAAQ,MAAM;IACpE,MAAM,WAAW,QAAQ,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,CAAC,IAAI,IAAI,KAAK,GAAG,KAAK,QAAQ,MAAM;IACtF,OAAO,KAAK,IAAI,CAAC,YAAY;AAC/B;AAEA,SAAS,aAAa,IAAiB,EAAE,WAAW,EAAE;IACpD,IAAI,CAAC,KAAK,MAAM,EAAE,OAAO;QAAE,MAAM;QAAM,KAAK;IAAK;IACjD,MAAM,QAAQ,KAAK,KAAK,CAAC,CAAC;IAC1B,MAAM,OAAO,KAAK,GAAG,IAAI,MAAM,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI;IAChD,MAAM,MAAM,KAAK,GAAG,IAAI,MAAM,GAAG,CAAC,CAAC,IAAM,EAAE,GAAG;IAC9C,OAAO;QAAE;QAAM;IAAI;AACrB;AAEA,SAAS,aAAa,KAAoB,EAAE,KAAoB,EAAE,MAAqB;IACrF,IAAI,SAAS,QAAQ,SAAS,QAAQ,UAAU,MAAM,OAAO;IAC7D,IAAI,QAAQ,SAAS,QAAQ,QAAQ,OAAO;IAC5C,IAAI,QAAQ,SAAS,QAAQ,QAAQ,OAAO;IAC5C,IAAI,QAAQ,OAAO,OAAO;IAC1B,IAAI,QAAQ,OAAO,OAAO;IAC1B,OAAO;AACT;AAEA,SAAS,mBAAmB,EAAa,EAAE,IAAiB;IAC1D,IAAI,CAAC,KAAK,MAAM,EAAE;QAChB,OAAO;YACL,WAAW;YACX,MAAM;YACN,OAAO;YACP,WAAW;YACX,OAAO;YACP,OAAO;YACP,QAAQ;YACR,OAAO;YACP,KAAK;YACL,QAAQ;YACR,WAAW;YACX,UAAU;YACV,OAAO;YACP,eAAe;QACjB;IACF;IACA,MAAM,OAAO,IAAI,CAAC,KAAK,MAAM,GAAG,EAAE;IAClC,MAAM,OAAO,IAAI,CAAC,KAAK,MAAM,GAAG,EAAE,IAAI;IACtC,MAAM,YAAY,OAAO,AAAC,CAAC,KAAK,KAAK,GAAG,KAAK,KAAK,IAAI,KAAK,KAAK,GAAI,MAAM;IAC1E,MAAM,MAAM,WAAW,MAAM;IAC7B,MAAM,SAAS,OAAO,KAAK,KAAK,GAAG,IAAI,AAAC,MAAM,KAAK,KAAK,GAAI,MAAM;IAClE,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,GAAG,aAAa,MAAM;IACzC,OAAO;QACL,WAAW;QACX,MAAM,KAAK,MAAM;QACjB,OAAO,KAAK,KAAK;QACjB;QACA,OAAO,KAAK,KAAK;QACjB,OAAO,KAAK,KAAK;QACjB,QAAQ,KAAK,MAAM;QACnB,OAAO,KAAK,KAAK;QACjB;QACA;QACA,WAAW;QACX,UAAU;QACV,OAAO,aAAa,KAAK,KAAK,EAAE,KAAK,KAAK,EAAE,KAAK,MAAM;QACvD,eAAe,qBAAqB,MAAM;IAC5C;AACF;AAEA,SAAS,cAAc,MAAwC;IAC7D,MAAM,MAAgB,EAAE;IACxB,MAAM,OAAO,IAAI;IACjB,KAAK,MAAM,SAAS,OAAQ;QAC1B,IAAI,SAAS,QAAQ,CAAC,OAAO,QAAQ,CAAC,QAAQ;QAC9C,MAAM,MAAM,MAAM,OAAO,CAAC;QAC1B,IAAI,CAAC,KAAK,GAAG,CAAC,MAAM;YAClB,KAAK,GAAG,CAAC;YACT,IAAI,IAAI,CAAC;QACX;IACF;IACA,OAAO;AACT;AAEA,SAAS,eAAe,UAAwD;IAC9E,MAAM,OAAO,UAAU,CAAC,KAAK;IAC7B,MAAM,OAAO,UAAU,CAAC,KAAK;IAC7B,MAAM,OAAO,UAAU,CAAC,KAAK;IAE7B,MAAM,aAAa;QAAC,MAAM;QAAO,MAAM;KAAM,CAAC,MAAM,CAAC;IACrD,MAAM,eAAe,WAAW,MAAM,CAAC,CAAC,IAAM,GAAG,SAAS,SAAS,MAAM;IACzE,MAAM,eAAe,WAAW,MAAM,CAAC,CAAC,IAAM,GAAG,SAAS,SAAS,MAAM;IAEzE,MAAM,SACJ,gBAAgB,IAAI,YAAY,gBAAgB,IAAI,YAAY,gBAAgB,eAAe,UAAU;IAE3G,MAAM,MAAM,MAAM,SAAS,MAAM,SAAS;IAC1C,MAAM,WAAW,OAAO,OAAO,YAAY,OAAO,KAAK,aAAa,OAAO,KAAK,aAAa;IAE7F,MAAM,MAAM,MAAM,iBAAiB,MAAM,iBAAiB;IAC1D,MAAM,aAAa,OAAO,OAAO,YAAY,OAAO,IAAI,SAAS,OAAO,MAAM,aAAa;IAE3F,MAAM,UAAU,cAAc;QAAC,MAAM;QAAU,MAAM;QAAU,MAAM;QAAQ,MAAM;KAAO;IAC1F,MAAM,aAAa,cAAc;QAAC,MAAM;QAAW,MAAM;QAAW,MAAM;QAAO,MAAM;KAAM;IAC7F,MAAM,SAAS,cAAc;QAAC,MAAM;QAAO,MAAM;QAAO,MAAM;KAAM;IAEpE,MAAM,kBAAkB,MAAM,KAAK,eAAe,KAAK,eAAe,IAAI,GAAG;IAE7E,OAAO;QACL;QACA;QACA;QACA,WAAW;YAAE;YAAS;YAAY;QAAO;QACzC;IACF;AACF;AAEA,eAAe,iBAAiB,MAAc;IAC5C,MAAM,MAAM,CAAC,kDAAkD,EAAE,QAAQ;IACzE,MAAM,MAAM,MAAM,MAAM,KAAK;QAAE,OAAO;IAAW;IACjD,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,sBAAsB,EAAE,IAAI,MAAM,EAAE;IAClE,MAAM,OAAY,MAAM,IAAI,IAAI;IAChC,OAAO;QACL,OAAO,QAAQ,KAAK,SAAS;QAC7B,cAAc,QAAQ,KAAK,kBAAkB;QAC7C,SAAS,QAAQ,KAAK,SAAS;QAC/B,QAAQ,QAAQ,KAAK,QAAQ;QAC7B,WAAW,QAAQ,KAAK,WAAW;QACnC,WAAW,KAAK,SAAS,GAAG,IAAI,KAAK,KAAK,SAAS,EAAE,WAAW,KAAK;IACvE;AACF;AAEA,MAAM,iBAAiB;IACrB,MAAM;IACN,sBAAsB;IACtB,YAAY;QACV,UAAU;YACR,MAAM;YACN,sBAAsB;YACtB,YAAY;gBACV,UAAU;oBAAE,MAAM;gBAAS;gBAC3B,SAAS;oBAAE,MAAM;gBAAS;gBAC1B,cAAc;oBAAE,MAAM;gBAAS;gBAC/B,UAAU;oBAAE,MAAM;gBAAS;gBAC3B,YAAY;oBAAE,MAAM;gBAAS;gBAC7B,WAAW;oBACT,MAAM;oBACN,sBAAsB;oBACtB,YAAY;wBACV,SAAS;4BAAE,MAAM;4BAAS,OAAO;gCAAE,MAAM;4BAAS;wBAAE;wBACpD,YAAY;4BAAE,MAAM;4BAAS,OAAO;gCAAE,MAAM;4BAAS;wBAAE;wBACvD,QAAQ;4BAAE,MAAM;4BAAS,OAAO;gCAAE,MAAM;4BAAS;wBAAE;oBACrD;oBACA,UAAU;wBAAC;wBAAW;wBAAc;qBAAS;gBAC/C;gBACA,WAAW;oBAAE,MAAM;oBAAS,OAAO;wBAAE,MAAM;oBAAS;gBAAE;gBACtD,YAAY;oBACV,MAAM;oBACN,sBAAsB;oBACtB,YAAY;wBACV,OAAO;4BAAE,MAAM;wBAAS;wBACxB,WAAW;4BAAE,MAAM;4BAAS,OAAO;gCAAE,MAAM;4BAAS;wBAAE;oBACxD;oBACA,UAAU;wBAAC;wBAAS;qBAAY;gBAClC;YACF;YACA,UAAU;gBAAC;gBAAY;gBAAW;gBAAgB;gBAAY;gBAAc;gBAAa;gBAAa;aAAa;QACrH;QACA,YAAY;YACV,MAAM;YACN,sBAAsB;YACtB,YAAY;gBACV,UAAU;oBAAE,MAAM;gBAAmB;gBACrC,OAAO;oBAAE,MAAM;gBAAmB;gBAClC,OAAO;oBAAE,MAAM;gBAAmB;YACpC;YACA,UAAU;gBAAC;gBAAY;gBAAS;aAAQ;QAC1C;IACF;IACA,UAAU;QAAC;QAAY;KAAa;IACpC,OAAO;QACL,UAAU;YACR,MAAM;YACN,sBAAsB;YACtB,YAAY;gBACV,MAAM;oBAAE,MAAM;gBAAS;gBACvB,MAAM;oBAAE,MAAM;oBAAU,MAAM;wBAAC;wBAAQ;wBAAS;qBAAU;gBAAC;gBAC3D,OAAO;oBAAE,MAAM;gBAAS;gBACxB,OAAO;oBACL,MAAM;oBACN,sBAAsB;oBACtB,YAAY;wBACV,MAAM;4BAAE,MAAM;4BAAU,MAAM;gCAAC;gCAAU;gCAAS;6BAAO;wBAAC;wBAC1D,OAAO;4BAAE,MAAM;gCAAC;gCAAU;6BAAO;wBAAC;wBAClC,MAAM;4BACJ,MAAM;gCAAC;gCAAU;6BAAO;4BACxB,sBAAsB;4BACtB,YAAY;gCAAE,IAAI;oCAAE,MAAM;gCAAS;gCAAG,IAAI;oCAAE,MAAM;gCAAS;4BAAE;4BAC7D,UAAU;gCAAC;gCAAM;6BAAK;wBACxB;oBACF;oBACA,UAAU;wBAAC;wBAAQ;wBAAS;qBAAO;gBACrC;gBACA,MAAM;oBAAE,MAAM;gBAAS;gBACvB,SAAS;oBAAE,MAAM;oBAAS,OAAO;wBAAE,MAAM;oBAAS;gBAAE;gBACpD,aAAa;oBAAE,MAAM;gBAAS;gBAC9B,gBAAgB;oBAAE,MAAM;gBAAS;gBACjC,cAAc;oBAAE,MAAM;gBAAS;gBAC/B,WAAW;oBAAE,MAAM;oBAAS,OAAO;wBAAE,MAAM;oBAAS;gBAAE;gBACtD,YAAY;oBAAE,MAAM;gBAAS;YAC/B;YACA,UAAU;gBACR;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;aACD;QACH;IACF;AACF;AAEA,SAAS,kBAAkB,IAAY;IACrC,MAAM,UAAU,KAAK,IAAI;IACzB,IAAI,QAAQ,UAAU,CAAC,QAAQ,QAAQ,QAAQ,CAAC,MAAM,OAAO;IAC7D,MAAM,QAAQ,QAAQ,OAAO,CAAC;IAC9B,MAAM,OAAO,QAAQ,WAAW,CAAC;IACjC,IAAI,SAAS,KAAK,OAAO,OAAO,OAAO,QAAQ,KAAK,CAAC,OAAO,OAAO;IACnE,OAAO;AACT;AAEA,SAAS,sBAAsB,OAAwB;IACrD,OAAO;QACL,UAAU,CAAC,YAAY,EAAE,QAAQ,MAAM,CAAC,MAAM,EAAE,QAAQ,QAAQ,CAAC,SAAS,CAAC;QAC3E,SACE;QACF,cAAc,QAAQ,MAAM;QAC5B,UAAU,QAAQ,QAAQ;QAC1B,YAAY,QAAQ,UAAU;QAC9B,WAAW,QAAQ,SAAS;QAC5B,WAAW;YAAC;SAAoF;QAChG,YAAY;YACV,OAAO,QAAQ,eAAe;YAC9B,WAAW;gBAAC;aAAsD;QACpE;IACF;AACF;AAEA,SAAS,wBAAwB,KAAoB,EAAE,OAAwB;IAC7E,MAAM,OAAO,QAAQ,MAAM,KAAK,YAAY,SAAS,QAAQ,MAAM,KAAK,YAAY,UAAU;IAC9F,MAAM,OAAO,SAAS,OAAO,QAAQ,CAAC,SAAS,QAAQ;IACvD,MAAM,SAAS,OAAO,OAAO,OAAO;IACpC,MAAM,OAAO,SAAS,SAAS,OAAO,SAAS,OAAO;IACtD,MAAM,UACJ,SAAS,UACL;QAAC,OAAO,SAAS;QAAK,OAAO,SAAS;KAAI,GAC1C;QAAC,OAAO,SAAS;QAAK,OAAO,SAAS;KAAI;IAEhD,MAAM,QAAQ,CAAC,MAAc,UAAoB,CAAC;YAChD;YACA,MAAM;YACN,OAAO;YACP,OAAO;gBAAE,MAAM;gBAAS,OAAO,QAAQ;gBAAW,MAAM;YAAK;YAC7D,MAAM,QAAQ;YACd;YACA,aAAa;YACb,gBAAgB;YAChB,cAAc;YACd,WAAW;gBAAC;aAAsD;YAClE,YAAY,QAAQ,eAAe;QACrC,CAAC;IAED,OAAO;QACL,UAAU,MAAM,iBAAiB;QACjC,OAAO,MAAM,cAAc;QAC3B,OAAO,MAAM,sBAAsB;IACrC;AACF;AAEA,eAAe,UAAU,OAAY;IACnC,MAAM,SAAS;IACf,MAAM,QACJ,QAAQ,GAAG,CAAC,uBAAuB,IACnC,QAAQ,GAAG,CAAC,kBAAkB,IAC9B,QAAQ,GAAG,CAAC,iBAAiB,IAC7B;IAEF,MAAM,WAAW,MAAM,OAAO,SAAS,CAAC,MAAM,CAAC;QAC7C;QACA,aAAa;QACb,mBAAmB;QACnB,MAAM;YACJ,QAAQ;gBACN,MAAM;gBACN,MAAM;gBACN,QAAQ;gBACR,QAAQ;YACV;QACF;QACA,cACE,6EACA,4GACA,4EACA;QACF,OAAO,KAAK,SAAS,CAAC;IACxB;IAEA,MAAM,OAAO,OAAO,AAAC,SAAiB,WAAW,IAAI,IAAI,IAAI;IAC7D,MAAM,WAAW,kBAAkB,SAAS;IAC5C,OAAO,KAAK,KAAK,CAAC;AACpB;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAQ,MAAM,IAAI,IAAI;QAE5B,MAAM,OAAO,KAAK,IAAI,KAAK,QAAQ,QAAQ;QAC3C,MAAM,cAAc,CAAC,KAAK,MAAM,IAAI,SAAS,EAAE,IAAI,GAAG,WAAW;QACjE,MAAM,WAAW,MAAM,KAAK,QAAQ,IAAI,CAAC,SAAS,QAAQ,MAAM,GAAG,GAAG,KAAK;QAE3E,MAAM,WAAW,WAAW;QAC5B,MAAM,gBAAgB,gBAAgB;QAEtC,MAAM,aAA0B,SAAS,QAAQ;YAAC;YAAO;YAAM;SAAK,GAAG;YAAC;YAAM;YAAM;SAAK;QAEzF,MAAM,KAAK;QACX,MAAM,WAAW,MAAM,QAAQ,GAAG,CAAC,WAAW,GAAG,CAAC,CAAC,KAAO,aAAa,IAAI,UAAU,IAAI;QACzF,MAAM,YAAY,WAAW,MAAM,CAA+C,CAAC,KAAK,IAAI;YAC1F,GAAG,CAAC,GAAG,GAAG,mBAAmB,IAAI,QAAQ,CAAC,MAAM;YAChD,OAAO;QACT,GAAG,CAAC;QAEJ,MAAM,OAAO,MAAM,iBAAiB;QACpC,MAAM,UAAU,eAAe;QAE/B,MAAM,UAAU;YACd,QAAQ;YACR;YACA;YACA,YAAY;YACZ;QACF;QAEA,IAAI,WAAgB;QACpB,IAAI,aAAkB;QACtB,IAAI,QAA+B;QACnC,IAAI;QAEJ,IAAI;YACF,MAAM,cAAc,MAAM,UAAU;YACpC,WAAW,YAAY,QAAQ;YAC/B,aAAa,YAAY,UAAU;YACnC,QAAQ;QACV,EAAE,OAAO,KAAU;YACjB,aAAa,KAAK,WAAW;YAC7B,WAAW,sBAAsB;YACjC,aAAa,wBAAwB,KAAK,KAAK,EAAE;QACnD;QAEA,MAAM,WAA+B;YACnC,IAAI;YACJ;YACA,QAAQ;YACR,aAAa,IAAI,OAAO,WAAW;YACnC;YACA;YACA;YACA,YAAY;YACZ;YACA;YACA;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC,UAAU;YAAE,QAAQ;QAAI;IACnD,EAAE,OAAO,KAAU;QACjB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO,KAAK,WAAW;QAAgB,GAAG;YAAE,QAAQ;QAAI;IAChG;AACF"}}]
}