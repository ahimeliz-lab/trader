{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lenovo/trader/app/api/close-position/route.ts"],"sourcesContent":["import \"server-only\";\nimport { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\ntype CloseRequest = {\n  accountId: string;\n  symbol: string;\n  priceTimeframe?: string;\n  reason?: string;\n  livePrice?: number;\n};\n\nfunction env(name: string): string {\n  const v = process.env[name];\n  if (!v) throw new Error(`Missing env var: ${name}`);\n  return v;\n}\n\nfunction sbAdmin() {\n  return createClient(env(\"SUPABASE_URL\"), env(\"SUPABASE_SERVICE_ROLE_KEY\"), {\n    auth: { persistSession: false },\n  });\n}\n\nfunction toPerp(sym: string) {\n  const s = sym.trim().toUpperCase();\n  return s.endsWith(\"-PERP\") ? s : `${s}-PERP`;\n}\n\nexport async function POST(req: Request) {\n  const sb = sbAdmin();\n  try {\n    const body = (await req.json()) as CloseRequest;\n    if (!body.accountId) return NextResponse.json({ ok: false, error: \"accountId required\" }, { status: 400 });\n    if (!body.symbol) return NextResponse.json({ ok: false, error: \"symbol required\" }, { status: 400 });\n\n    const symbol = toPerp(body.symbol);\n    const tf = (body.priceTimeframe ?? \"15m\").toLowerCase();\n\n    const { data: pos, error: posErr } = await sb\n      .from(\"trade_positions\")\n      .select(\"symbol,qty,avg_entry_price\")\n      .eq(\"account_id\", body.accountId)\n      .eq(\"symbol\", symbol)\n      .maybeSingle();\n    if (posErr) throw new Error(`Position lookup failed: ${posErr.message}`);\n    const qty = Number(pos?.qty ?? 0);\n    if (!Number.isFinite(qty) || qty === 0) {\n      return NextResponse.json({ ok: true, status: \"no_position\" }, { status: 200 });\n    }\n\n    let fillPrice = Number(body.livePrice ?? NaN);\n    if (!Number.isFinite(fillPrice) || fillPrice <= 0) {\n      const { data: lastCandle, error: candleErr } = await sb\n        .from(\"candles\")\n        .select(\"close\")\n        .eq(\"symbol\", symbol)\n        .eq(\"timeframe\", tf)\n        .order(\"open_time\", { ascending: false })\n        .limit(1)\n        .maybeSingle();\n      if (candleErr) throw new Error(`Candle lookup failed: ${candleErr.message}`);\n      fillPrice = Number(lastCandle?.close);\n    }\n\n    if (!Number.isFinite(fillPrice) || fillPrice <= 0) {\n      return NextResponse.json({ ok: false, error: \"No price available to close.\" }, { status: 422 });\n    }\n\n    const side = qty > 0 ? \"sell\" : \"buy\";\n    const closeQty = Math.abs(qty);\n    const clientOrderId = `close_${Date.now()}`;\n\n    const { data: order, error: orderErr } = await sb\n      .from(\"trade_orders\")\n      .insert({\n        account_id: body.accountId,\n        client_order_id: clientOrderId,\n        symbol,\n        side,\n        type: \"market\",\n        qty: closeQty,\n        leverage: 1,\n        status: \"new\",\n        note: body.reason ?? \"close_position\",\n      })\n      .select(\"*\")\n      .single();\n    if (orderErr) throw new Error(`Order insert failed: ${orderErr.message}`);\n\n    const { error: fillErr } = await sb.from(\"trade_fills\").insert({\n      order_id: order.id,\n      account_id: body.accountId,\n      symbol,\n      side,\n      qty: closeQty,\n      price: fillPrice,\n      fee_usd: 0,\n    });\n    if (fillErr) throw new Error(`Fill insert failed: ${fillErr.message}`);\n\n    const { error: applyErr } = await sb.rpc(\"apply_fill_to_position_and_cash\", {\n      p_account_id: body.accountId,\n      p_symbol: symbol,\n      p_side: side,\n      p_qty: closeQty,\n      p_price: fillPrice,\n      p_fee_usd: 0,\n    });\n    if (applyErr) throw new Error(`apply_fill_to_position_and_cash failed: ${applyErr.message}`);\n\n    await sb.from(\"trade_orders\").update({ status: \"filled\" }).eq(\"id\", order.id);\n\n    // Trade journal close (best effort)\n    try {\n      const { data: j } = await sb\n        .from(\"trade_journal\")\n        .select(\"id,entry_price,qty,side\")\n        .eq(\"account_id\", body.accountId)\n        .eq(\"symbol\", symbol)\n        .eq(\"status\", \"open\")\n        .order(\"entry_time\", { ascending: false })\n        .limit(1)\n        .maybeSingle();\n      if (j?.id) {\n        const entryPrice = Number(j.entry_price ?? 0);\n        const qtyJ = Number(j.qty ?? closeQty);\n        const dir = (j.side ?? \"buy\") === \"buy\" ? 1 : -1;\n        const pnl = Number.isFinite(entryPrice) ? (fillPrice - entryPrice) * qtyJ * dir : null;\n        await sb\n          .from(\"trade_journal\")\n          .update({\n            exit_price: fillPrice,\n            exit_time: new Date().toISOString(),\n            pnl_usd: pnl,\n            status: \"closed\",\n            exit_reason: body.reason ?? \"manual_close\",\n          })\n          .eq(\"id\", j.id);\n      }\n    } catch {\n      // ignore\n    }\n\n    return NextResponse.json(\n      { ok: true, status: \"closed\", orderId: order.id, fill: { price: fillPrice, qty: closeQty } },\n      { status: 200 }\n    );\n  } catch (e) {\n    return NextResponse.json({ ok: false, error: (e as Error).message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}